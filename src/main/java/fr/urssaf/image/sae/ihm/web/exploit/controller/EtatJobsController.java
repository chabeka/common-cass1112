package fr.urssaf.image.sae.ihm.web.exploit.controller;

import java.io.PrintWriter;
import java.io.StringWriter;
import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;

import org.apache.curator.framework.CuratorFramework;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;

import com.datastax.driver.core.CodecRegistry;
import com.datastax.driver.core.TypeCodec;
import com.datastax.driver.core.exceptions.CodecNotFoundException;
import com.datastax.driver.extras.codecs.enums.EnumNameCodec;

import fr.urssaf.image.commons.cassandra.cql.codec.BytesBlobCodec;
import fr.urssaf.image.commons.cassandra.cql.codec.JsonCodec;
import fr.urssaf.image.commons.cassandra.helper.CassandraCQLClientFactory;
import fr.urssaf.image.sae.commons.bo.ParameterRowType;
import fr.urssaf.image.sae.commons.bo.ParameterType;
import fr.urssaf.image.sae.commons.utils.ObjectCodec;
import fr.urssaf.image.sae.ihm.web.exploit.modele.ConfigurationsEnvironnement;
import fr.urssaf.image.sae.ihm.web.exploit.modele.EtatJobSAE;
import fr.urssaf.image.sae.ihm.web.exploit.service.EtatJobsService;
import fr.urssaf.image.sae.ihm.web.exploit.service.impl.EtatJobsServiceImpl;
import fr.urssaf.image.sae.ihm.web.exploit.utils.Constants;
import fr.urssaf.image.sae.vi.modele.VIContenuExtrait;
import me.prettyprint.hector.api.Keyspace;

/**
 * Classe permettant de gérer l'etat des jobs
 * 
 * 
 */
@Controller
public class EtatJobsController {

  @Autowired
  private ConfigurationsEnvironnement config;

  /**
   * Recuperes l'etat des jobs SAE
   * 
   * @param model
   *           le modèle
   * @param session
   *           la session
   * @param request
   *           la requête
   * @return la page à afficher
   * @throws InterruptedException
   *            Exception
   */
  @RequestMapping(value = "etatJobsSAE", method = RequestMethod.GET)
  public final String etatJobsSAE(final Model model, final HttpSession session,
                                  final HttpServletRequest request) throws InterruptedException {

    try {
      // Récupération de la configuration choisie
      final String nomConf = (String) session.getAttribute("nomConfiguration");
      final Keyspace keyspace = (Keyspace) session.getServletContext()
          .getAttribute(nomConf);
      final CassandraCQLClientFactory ccf = (CassandraCQLClientFactory) session.getServletContext()
          .getAttribute(Constants.CQL);
      final CuratorFramework curator = (CuratorFramework) session
          .getServletContext().getAttribute(nomConf + "-zookeeper");

      if (ccf != null) {
        /**
         * On initialise les codec pour la gestion des Object et des enums
         */
        final CodecRegistry registry = ccf.getCluster().getConfiguration().getCodecRegistry();
        registerCodecIfNotFound(registry, ObjectCodec.instance);
        registerCodecIfNotFound(registry, new EnumNameCodec<>(ParameterType.class));
        registerCodecIfNotFound(registry, new EnumNameCodec<>(ParameterRowType.class));
        registerCodecIfNotFound(registry, new JsonCodec<>(VIContenuExtrait.class));
        registerCodecIfNotFound(registry, BytesBlobCodec.instance);
      }

      final EtatJobsService etatJobsService = new EtatJobsServiceImpl(keyspace,
                                                                      config,
                                                                      curator,
                                                                      ccf);

      final List<EtatJobSAE> etatJobsSae = etatJobsService.getEtatJobsSAE();
      request.setAttribute("etatJobsSae", etatJobsSae);

    } catch (final Exception e) {
      final StringWriter sw = new StringWriter();
      final PrintWriter pw = new PrintWriter(sw);
      e.printStackTrace(pw);
      final String stacktrace = sw.toString();
      request.setAttribute("stacktrace", stacktrace);
    }

    return "etatJobsSAE";

  }

  private void registerCodecIfNotFound(final CodecRegistry registry, final TypeCodec<?> codec) {
    try {
      registry.codecFor(codec.getCqlType(), codec.getJavaType());
    }
    catch (final CodecNotFoundException e) {
      registry.register(codec);
    }
  }
}
