package fr.urssaf.image.sae.admin.dfce.exploit.executable;

import junit.framework.Assert;

import org.apache.commons.lang.SystemUtils;
import org.easymock.EasyMock;
import org.junit.After;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.ApplicationContext;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;

import fr.urssaf.image.sae.admin.dfce.exploit.exception.BaseAdministrationPermissionEx;
import fr.urssaf.image.sae.admin.dfce.exploit.exception.ConnectionServiceEx;
import fr.urssaf.image.sae.admin.dfce.exploit.exception.GeneralAdminDfceException;
import fr.urssaf.image.sae.admin.dfce.exploit.model.ConnectionParameter;
import fr.urssaf.image.sae.admin.dfce.exploit.services.ArchiveLogSystemDFCEService;

@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(locations = { "/applicationContext-sae-dfce-admin-exploit-service-mock-test.xml" })
@SuppressWarnings("PMD.MethodNamingConventions")
public class ArchiveLogSystemDFCEServiceMainTest {

   private AdministrationSAEMain administrationSAEMain;

   @Autowired
   private ArchiveLogSystemDFCEService service;

   @Autowired
   private ApplicationContext context;

   @Before
   public void before() {

      administrationSAEMain = new AdministrationSAEMain(
            "applicationContext-sae-dfce-admin-exploit-mock-test.xml");

   }

   @After
   public void after() {

      EasyMock.reset(service);

   }

   private void assertService() {

      EasyMock.verify(service);
   }

   @Test
   public void creatSystemEvent_success() throws ConnectionServiceEx,
         GeneralAdminDfceException {

      service.createSystemEventLogs(EasyMock
            .anyObject(ConnectionParameter.class), EasyMock.anyInt());

      EasyMock.replay(service);

      administrationSAEMain.executeService("creatSystemEvent", context,
            new String[0]);

      assertService();

   }

   @Test
   public void clearSystemEvent_success() throws ConnectionServiceEx,
         GeneralAdminDfceException {

      service.purgeSystemEvents(EasyMock.anyObject(ConnectionParameter.class),
            EasyMock.eq(30));

      EasyMock.replay(service);

      administrationSAEMain.executeService("clearSystemEvent", context,
            new String[] { "30" });

      assertService();

   }

   @Test
   public void consultSystemEvent_success() throws ConnectionServiceEx,
         GeneralAdminDfceException {

      String dir = SystemUtils.getJavaIoTmpDir().getAbsolutePath();

      service.extractSystemArchiveFile(EasyMock
            .anyObject(ConnectionParameter.class), EasyMock.eq(dir));

      EasyMock.replay(service);

      administrationSAEMain.executeService("consultSystemEvent", context,
            new String[] { dir });

      assertService();

   }

   @Test
   public void consultSystemEvent_failure_depot_non_renseignee()
         throws ConnectionServiceEx, GeneralAdminDfceException {

      assertConsultSystemEvent_failure(null);
      assertConsultSystemEvent_failure("");

   }

   private void assertConsultSystemEvent_failure(String filePath)
         throws GeneralAdminDfceException, ConnectionServiceEx {

      try {

         administrationSAEMain.executeService("consultSystemEvent", context,
               new String[] { filePath });

         Assert.fail("le service doit lever une IllegalArgumentException");

      } catch (IllegalArgumentException e) {

         Assert.assertEquals("le message de l'exception est inattendu",
               "Le chemin de dépot des fichier de log doit être renseigné.", e
                     .getMessage());
      }
   }

   @Test
   public void consultSystemEvent_failure_depot_not_exist()
         throws ConnectionServiceEx, GeneralAdminDfceException {

      try {

         administrationSAEMain.executeService("consultSystemEvent", context,
               new String[] { "/fileNotExist" });

         Assert
               .fail("le service doit lever une BaseAdministrationPermissionEx");

      } catch (BaseAdministrationPermissionEx e) {

         Assert
               .assertEquals(
                     "le message de l'exception est inattendu",
                     "Le SAE ne dispose pas des droits d'écriture dans le répertoire /fileNotExist",
                     e.getMessage());
      }

   }

   @Test
   public void creatSystemEvent_failure() throws ConnectionServiceEx,
         GeneralAdminDfceException {

      assertcreatSystemEvent_failure("aaa");
      assertcreatSystemEvent_failure("");
      assertcreatSystemEvent_failure(null);

   }

   private void assertcreatSystemEvent_failure(String duree)
         throws GeneralAdminDfceException, ConnectionServiceEx {

      try {

         administrationSAEMain.executeService("clearSystemEvent", context,
               new String[] { duree });

         Assert.fail("le service doit lever une IllegalArgumentException");

      } catch (IllegalArgumentException e) {

         Assert.assertEquals("le message de l'exception est inattendu",
               "La durée de conservation doit être renseigné.", e.getMessage());
      }
   }

}
