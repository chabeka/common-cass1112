<?xml version="1.0" encoding="UTF-8"?>
<beans:beans xmlns:beans="http://www.springframework.org/schema/beans"
   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.springframework.org/schema/batch"
   xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
      http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch-2.1.xsd">


   <job id="restore_masse">
   
      <listeners>
         <listener ref="restoreMasseJobListener" />
      </listeners>
   
      <!-- Verifier droit de suppression -->
      <step id="controleDroitRestoreStep">
         <tasklet ref="checkDroitRestoreTasklet">
            <listeners>
               <listener ref="checkStateRestoreAfterStepListener" />
            </listeners>
         </tasklet>

         <fail on="FAILED" />
         <next on="*" to="restoreDeLaCorbeilleStep" />
      </step>
       
      <step id="restoreDeLaCorbeilleStep">
         <tasklet>
            <!-- 
               Le recycleBeanStorageDocumentReader permet de : 
                  - récupérer les documents à partir de la requête lucene dans la corbeille
               Le restoreMasseProcessor permet de :
                  - Vérifier que le document est gelé ou non (les documents gelés étants ignorés)
                  - Mise a jour l'identifiant de retore de masse dans l'objet StorageDocument
               Le storageDocumentFromRecycleWriter permet : 
                  - mettre a jour la métadonnées identifiant de restore de masse en base de données
                  - restorer le document de corbeille
                  - tracer l'évenement de restore
            -->
            <chunk reader="recycleBeanStorageDocumentReader" processor="restoreMasseProcessor"
               writer="storageDocumentFromRecycleWriter" commit-interval="5" />
            <listeners>
               <listener ref="checkStateRestoreAfterStepListener" />
               <listener ref="storageDocumentFromRecycleListener" />
            </listeners>
         </tasklet>
      </step>

   </job>

</beans:beans>
