<?xml version="1.0" encoding="UTF-8"?>
<beans:beans xmlns:beans="http://www.springframework.org/schema/beans"
   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.springframework.org/schema/batch"
   xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
      http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch-2.1.xsd">


   <job id="suppression_masse">
   
      <listeners>
         <listener ref="suppressionMasseJobListener" />
      </listeners>
   
      <!-- Controler la requete lucene -->
      <step id="controleRequeteLuceneStep">
         <tasklet ref="checkRequeteLuceneTasklet">
            <listeners>
               <listener ref="checkStateSuppressionAfterStepListener" />
            </listeners>
         </tasklet>

         <fail on="FAILED" />
         <next on="*" to="controleDroitRequeteLuceneStep" />
      </step>
      
      <!-- Verifier droit de suppression -->
      <step id="controleDroitRequeteLuceneStep">
         <tasklet ref="checkDroitRequeteLuceneTasklet">
            <listeners>
               <listener ref="checkStateSuppressionAfterStepListener" />
            </listeners>
         </tasklet>

         <fail on="FAILED" />
         <next on="*" to="miseALaCorbeilleStep" />
      </step>
      
      <step id="miseALaCorbeilleStep">
         <tasklet>
            <!-- 
               Le storageDocumentReader permet de : 
                  - récupérer les documents à partir de la requête lucene 
               Le suppressionMasseProcessor permet de :
                  - Vérifier que le document est gelé ou non (les documents gelés étants ignorés)
                  - Mise a jour l'identifiant de suppression de masse et la date de mise en corbeille dans l'objet StorageDocument
               Le storageDocumentToRecycleWriter permet : 
                  - mettre a jour la métadonnées identifiant de suppression de masse et date de mmise en corbeille en base de données
                  - mettre le document en corbeille
                  - tracer l'évenement de mise à la corbeille
            -->
            <chunk reader="storageDocumentReader" processor="suppressionMasseProcessor"
               writer="storageDocumentToRecycleWriter" commit-interval="5" />
            <listeners>
               <listener ref="checkStateSuppressionAfterStepListener" />
               <listener ref="storageDocumentToRecycleListener" />
            </listeners>
         </tasklet>
      </step>

   </job>

</beans:beans>
