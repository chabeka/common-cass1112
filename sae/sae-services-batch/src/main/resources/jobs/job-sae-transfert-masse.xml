<?xml version="1.0" encoding="UTF-8"?>
<beans:beans xmlns:beans="http://www.springframework.org/schema/beans"
   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.springframework.org/schema/batch"
   xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
		http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch-2.1.xsd">


   <job id="transfert_masse">

      <listeners>
         <listener ref="transfertMasseJobListener" />
      </listeners>

      <!-- Controle du fichier sommaire.xml -->
      <step id="controleSommaireStep">

         <tasklet ref="checkFileSommaireTasklet">
            <listeners>
               <listener ref="checkStateAfterStepListener" />
            </listeners>
         </tasklet>

         <next on="FAILED" to="finBloquant" />
         <next on="*" to="debutTraitement" />
      </step>

      <step id="debutTraitement">
         <tasklet ref="debutTraitementFlagTasklet">
            <listeners>
               <listener ref="checkEcdePermissionBeforeStepListener" />
               <listener ref="debutTraitementFlagListener" />
               <listener ref="checkEcdePermissionAfterStepListener" />
            </listeners>
         </tasklet>

         <next on="FAILED" to="finBloquant" />
         <next on="FAILED_FIN_BLOQUANT" to="finBloquant" />
         <next on="*" to="controleFormatSommaireTransfertStep" />

      </step>

      <step id="controleFormatSommaireTransfertStep">
         <tasklet ref="checkFormatFileSommaireTransfertTasklet">
            <listeners>
               <listener ref="checkEcdePermissionBeforeStepListener" />
               <listener ref="checkStateAfterStepListener" />
               <listener ref="checkEcdePermissionAfterStepListener" />
            </listeners>
         </tasklet>

         <next on="FAILED" to="finBloquant" />
         <next on="FAILED_FIN_BLOQUANT" to="finBloquant" />
         <next on="*" to="compteElementsTransfert" />
      </step>

      <step id="compteElementsTransfert">
         <tasklet ref="countSommaireDocumentsTransfertTasklet">
            <listeners>
               <listener ref="checkEcdePermissionBeforeStepListener" />
               <listener ref="countSommaireDocumentsListener" />
               <listener ref="checkEcdePermissionAfterStepListener" />
            </listeners>
         </tasklet>

         <next on="FAILED" to="finBloquant" />
         <next on="FAILED_FIN_BLOQUANT" to="finBloquant" />
         <next on="DOCS" to="controleModeBatch" />
         <next on="VDOCS" to="finBloquant" />

      </step>

      <!-- controle du mode de traitement pour redirection -->
      <step id="controleModeBatch">
         <tasklet ref="controleModeBatchTasklet">
            <listeners>
               <listener ref="checkEcdePermissionBeforeStepListener" />
               <listener ref="controleModeBatchListener" />
               <listener ref="checkEcdePermissionAfterStepListener" />
            </listeners>
         </tasklet>

         <next on="PAR" to="transfertDocuments" />
         <next on="*" to="finBloquant" />
      </step>

      <!-- controle et transfert ou suppression pour document a ajouter ici -->
      <step id="transfertDocuments">
         <tasklet>
            <chunk reader="sommaireReaderTransfert" processor="compositeProcessorTransfert"
               writer="transfertDocumentWriter" commit-interval="5" />
            <listeners>
               <listener ref="checkEcdePermissionBeforeStepListener" />         
               <listener ref="convertSommaireDocumentTransfertProcessor" />
               <listener ref="controleDocumentSommaireTransfertProcessor" />       
               <listener ref="transfertDocumentWriter" />     
               <listener ref="transfertListener" />
               <listener ref="checkEcdePermissionAfterStepListener" />
            </listeners>
         </tasklet>


         <next on="FAILED" to="finErreurTransfert" />
         <next on="FAILED_FIN_BLOQUANT" to="finBloquant" />
         <next on="FAILED_NO_ROLLBACK" to="finErreurTransfert" />
         <next on="*" to="finSuccesTransfert" />
      </step>

      <step id="finBloquant">
         <tasklet ref="resultatsFileFailureErrorTasklet">
            <listeners>
               <listener ref="resultatsFileFailureErrorListener" />
            </listeners>
         </tasklet>
         <next on="*" to="finTraitement" />
      </step>

      <step id="finErreurTransfert">
         <tasklet ref="resultatsFileFailureTransfertTasklet">
            <listeners>
               <listener ref="checkEcdePermissionBeforeStepListener" />
               <listener ref="resultatsFileFailureListener" />
               <listener ref="checkEcdePermissionAfterStepListener" />
            </listeners>
         </tasklet>

         <next on="FAILED_FIN_BLOQUANT" to="finBloquant" />
         <next on="*" to="finTraitement" />
      </step>

      <step id="finSuccesTransfert">
         <tasklet ref="resultatsFileSuccessTransfertTasklet">
            <listeners>
               <listener ref="checkEcdePermissionBeforeStepListener" />
               <listener ref="resultatsFileSuccessListener" />
               <listener ref="checkEcdePermissionAfterStepListener" />
            </listeners>
         </tasklet>

         <next on="FAILED_FIN_BLOQUANT" to="finBloquant" />
         <next on="*" to="finTraitement" />
      </step>

      <step id="finTraitement">
         <tasklet ref="finTraitementFlagTasklet">
            <listeners>
               <listener ref="checkEcdePermissionBeforeStepListener" />
               <listener ref="finTraitementFlagListener" />
               <listener ref="checkEcdePermissionAfterStepListener" />
            </listeners>
         </tasklet>
      </step>

   </job>

</beans:beans>