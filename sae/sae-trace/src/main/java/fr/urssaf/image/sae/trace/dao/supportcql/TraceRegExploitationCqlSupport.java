/**
 *  TODO (AC75095028) Description du fichier
 */
package fr.urssaf.image.sae.trace.dao.supportcql;

import java.util.Date;
import java.util.Iterator;
import java.util.UUID;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import fr.urssaf.image.commons.cassandra.cql.dao.IGenericDAO;
import fr.urssaf.image.sae.trace.dao.modelcql.TraceRegExploitationCql;
import fr.urssaf.image.sae.trace.dao.modelcql.TraceRegExploitationIndexCql;
import fr.urssaf.image.sae.trace.daocql.ITraceRegExploitationCqlDao;
import fr.urssaf.image.sae.trace.daocql.ITraceRegExploitationIndexCqlDao;
import fr.urssaf.image.sae.trace.support.TimeUUIDEtTimestampSupport;
import fr.urssaf.image.sae.trace.utils.DateRegUtils;

/**
 * Support de la classe DAO {@link ITraceRegExploitationIndexCqlDao}
 */
@Component
public class TraceRegExploitationCqlSupport extends GenericAbstractTraceCqlSupport<TraceRegExploitationCql, TraceRegExploitationIndexCql> {

  private static final String REG_EXPLOIT_NAME = "registre d'exploitation";

  private final ITraceRegExploitationCqlDao dao;

  private final ITraceRegExploitationIndexCqlDao indexDao;

  private final TimeUUIDEtTimestampSupport timeUUIDSupport;

  private static final Logger LOGGER = LoggerFactory.getLogger(TraceRegExploitationCqlSupport.class);

  /**
   * Constructeur
   *
   * @param dao
   *          Service DAO de la famille de colonnes "TraceRegExploitation"
   * @param indexDao
   *          Service DAO de la famille de colonnes
   *          "TraceRegExploitationIndex"
   * @param timeUUIDSupport
   *          Utilitaires pour cr√©er des TimeUUIDa
   */
  @Autowired
  public TraceRegExploitationCqlSupport(final ITraceRegExploitationCqlDao dao,
                                        final ITraceRegExploitationIndexCqlDao indexDao,
                                        final TimeUUIDEtTimestampSupport timeUUIDSupport) {
    super();
    this.dao = dao;
    this.indexDao = indexDao;
    this.timeUUIDSupport = timeUUIDSupport;
  }

  /**
   * {@inheritDoc}
   */
  @Override
  public Iterator<TraceRegExploitationIndexCql> getIterator(final Date date) {
    final String journee = DateRegUtils.getJournee(date);
    return indexDao.IterableFindById(journee);
  }

  /**
   * {@inheritDoc}
   */
  @Override
  public IGenericDAO<TraceRegExploitationCql, UUID> getDao() {
    return dao;
  }

  /**
   * {@inheritDoc}
   */
  @Override
  public IGenericDAO<TraceRegExploitationIndexCql, String> getIndexDao() {
    return indexDao;
  }

  /**
   * {@inheritDoc}
   */
  @Override
  TraceRegExploitationIndexCql getIndexFromTrace(final TraceRegExploitationCql trace) {
    final TraceRegExploitationIndexCql index = new TraceRegExploitationIndexCql(trace);
    // date en string sous la forme de YYYYMMJJ sans les heures et les secondes
    final String journee = DateRegUtils.getJournee(index.getTimestamp());
    index.setIdentifiantIndex(journee);
    return index;
  }

  /**
   * {@inheritDoc}
   */
  @Override
  String getRegistreName() {
    return REG_EXPLOIT_NAME;
  }

  /**
   * {@inheritDoc}
   */
  @Override
  UUID getTraceId(final TraceRegExploitationIndexCql trace) {
    return trace.getIdentifiant();
  }

  /**
   * {@inheritDoc}
   */
  @Override
  TraceRegExploitationCql createNewInstance(final UUID idTrace, final Date timestamp) {
    return new TraceRegExploitationCql(idTrace, timestamp);
  }

  /**
   * {@inheritDoc}
   */
  @Override
  TimeUUIDEtTimestampSupport getTimeUuidSupport() {
    return timeUUIDSupport;
  }

  /**
   * {@inheritDoc}
   */
  @Override
  Logger getLogger() {
    return LOGGER;
  }

}
