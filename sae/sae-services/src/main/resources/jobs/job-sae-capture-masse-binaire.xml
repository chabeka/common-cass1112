<?xml version="1.0" encoding="UTF-8"?>
<beans:beans xmlns:beans="http://www.springframework.org/schema/beans"
   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.springframework.org/schema/batch"
   xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
		http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch-2.1.xsd">


   <job id="capture_masse">

      <!-- Controle du fichier sommaire.xml -->
      <step id="controleSommaireStep">

         <tasklet ref="checkFileSommaireTasklet">
            <listeners>
               <listener ref="checkFileSommaireListener" />
            </listeners>
         </tasklet>

         <next on="FAILED" to="finBloquant" />
         <next on="*" to="debutTraitement" />
      </step>

      <step id="debutTraitement">
         <tasklet ref="debutTraitementFlagTasklet">
            <listeners>
               <listener ref="debutTraitementFlagListener" />
            </listeners>
         </tasklet>

         <next on="FAILED" to="finBloquant" />
         <next on="*" to="controleFormatSommaireStep" />

      </step>

      <step id="controleFormatSommaireStep">
         <tasklet ref="checkFormatFileSommaireTasklet">
            <listeners>
               <listener ref="checkFormatFileSommaireListener" />
            </listeners>
         </tasklet>

         <next on="FAILED" to="finBloquant" />
         <next on="*" to="controleDocuments" />
      </step>


      <!-- contrÃ´le des documents du fichier sommaire.xml -->
      <step id="controleDocuments">
         <tasklet>
            <chunk reader="sommaireReader" processor="compositeControlProcessor"
               writer="emptyWriter" commit-interval="1000" />
            <listeners>
               <listener ref="controleListener" />
               <listener ref="controleSommaireDocumentProcessor" />
            </listeners>
         </tasklet>

         <next on="FAILED" to="finErreur" />
         <next on="*" to="persistanceDocuments" />
      </step>

      <!-- persistance des documents du fichier sommaire.xml -->

      <step id="persistanceDocuments">
         <tasklet>
            <chunk reader="sommaireReader" processor="compositeProcessorControlePersistance"
               writer="storageDocumentWriter" commit-interval="5" />
            <listeners>
               <listener ref="storageDocumentWriter" />
               <listener ref="controleStorageDocumentProcessor" />
               <listener ref="stockageListener" />
            </listeners>
         </tasklet>


         <next on="FAILED" to="rollback" />
         <next on="*" to="finSucces" />
      </step>

      <step id="rollback">
         <tasklet ref="rollbackTasklet" />

         <next on="*" to="finErreur" />
      </step>

      <step id="finBloquant">
         <tasklet ref="resultatsFileFailureErrorTasklet">
            <listeners>
               <listener ref="resultatsFileFailureErrorListener" />
            </listeners>
         </tasklet>
         <next on="*" to="finTraitement" />
      </step>

      <step id="finErreur">
         <tasklet ref="resultatsFileFailureTasklet">
            <listeners>
               <listener ref="resultatsFileFailureListener" />
            </listeners>
         </tasklet>

         <next on="*" to="finTraitement" />
      </step>

      <step id="finSucces">
         <tasklet ref="resultatsFileSuccessTasklet">
            <listeners>
               <listener ref="resultatsFileSuccessListener" />
            </listeners>
         </tasklet>
         <next on="*" to="finTraitement" />
      </step>

      <step id="finTraitement">
         <tasklet ref="finTraitementFlagTasklet">
            <listeners>
               <listener ref="finTraitementFlagListener" />
            </listeners>
         </tasklet>
      </step>


   </job>

</beans:beans>
