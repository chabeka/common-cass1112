<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib prefix="form" uri="http://www.springframework.org/tags/form"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib uri="http://displaytag.sf.net" prefix="display"%>
<%@taglib prefix="custom" uri="/WEB-INF/tld/map.tld"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>IHM Web Exploit - Consultation des traces</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<link href="css/displaytag.css" rel="stylesheet" type="text/css" />
<link href="css/formulaire.css" rel="stylesheet" type="text/css" />
<link href="css/calendrier.css" rel="stylesheet" media="screen" type="text/css" title="Design"  />

<script type="text/javascript" src="js/calendrier.js"></script>
<script type="text/javascript">
//<![CDATA[
           
   function selectionnerParId() {
      document.getElementById("modeIdentifiant").checked = true;
      majListeDeroulante();
   }

   function selectionnerParDates() {
      document.getElementById("modeDate").checked = true;
      majListeDeroulante();
   }

   function majListeDeroulante() {
      if (document.getElementById("modeIdentifiant").checked == true) {
		document.getElementById("typeTrace").value = "CYCLE_VIE";
		document.getElementById("typeTrace").disabled = true;
		desactiverFiltrageCodeEvt();
		desactiverFiltrageContratService();
		document.getElementById("typeTraceHidden").value = "CYCLE_VIE";
		
      } else {
         document.getElementById("typeTrace").disabled = false;
         document.getElementById("typeTraceHidden").value = "";
      }
   }

   function verificationForm() {
      document.getElementById("typeTraceHidden").value = document.getElementById("typeTrace").value;
      if (document.getElementById("modeIdentifiant").checked == true) {
		if (document.getElementById("idDoc").value == "") {
			document.getElementById("erreur").innerHTML = "L'identifiant du document doit être renseigné";	
			return false;
			}
      }
      if (document.getElementById("modeDate").checked == true) {
   		if (document.getElementById("dateDebut").value == "") {
   			document.getElementById("erreur").innerHTML = "La date de début doit être renseignée";	
   			return false;
   		}
   		if (document.getElementById("dateFin").value == "") {
   			document.getElementById("erreur").innerHTML = "La date de fin doit être renseignée";	
   			return false;
   		}
   		if (document.getElementById("taille").value == "" || document.getElementById("taille").value <= 0) {
   			document.getElementById("erreur").innerHTML = "La nombre de traces à récupérer doit être renseignée et supérieure à 0";	
   			return false;
   		}
      }

      return true;
   }

   function initForm() {
      if (document.getElementById("modeIdentifiant").checked == true) {
        desactiverFiltrageCodeEvt();
        desactiverFiltrageContratService();
   		document.getElementById("typeTrace").value = "CYCLE_VIE";
   		document.getElementById("typeTrace").disabled = true;
   		document.getElementById("typeTraceHidden").value = "CYCLE_VIE";
      } else {
         if (document.getElementById("typeTraceHidden").value == "") {
         	document.getElementById("typeTrace").value = "TECHNIQUE";
         }
         filtrage();
      }


      var nbSel = 0;
      var tab = document.getElementById("filtrageTechnique");
      for (i=0; i < tab.length; i++) {
      	if (tab[i].selected == true) {
         	nbSel++;
      	}
      }
      if (nbSel == 0) {
	      document.getElementById("filtrageTechnique")[0].selected = true;
      }
      
   }

   function filtrage() {
      desactiverFiltrageCodeEvt();
      desactiverFiltrageContratService();
      desactiverFiltrageHistoEvt();
      if (document.getElementById("typeTrace").value == "TECHNIQUE") {
         document.getElementById("selectionTechnique").style.display = "inline";
         document.getElementById("filtrageTechnique").disabled = false;
         activerFiltrageContratService()
      }
      if (document.getElementById("typeTrace").value == "JOURNAL_EVT") {
         document.getElementById("selectionJournalEvt").style.display = "inline";
         document.getElementById("filtrageJournalEvt").disabled = false;
         document.getElementById("selectionJournalEvt").style.display = "inline";
         document.getElementById("filtrageJournalEvt").disabled = false;
         activerFiltrageContratService();
      }
      if(document.getElementById("typeTrace").value == "HIST_EVT"){
    	  activerFiltrageHistoEvt();
      }
   }

   function desactiverFiltrageCodeEvt() {
      document.getElementById("filtrageJournalEvt").disabled = true;
      document.getElementById("filtrageTechnique").disabled = true;
      document.getElementById("selectionTechnique").style.display = "none";
      document.getElementById("selectionJournalEvt").style.display = "none";		
   }

   function desactiverFiltrageHistoEvt() {
      document.getElementById("filtrageHistEvt").disabled = true;
      document.getElementById("selectionHistEvt").style.display = "none";
   }
   function activerFiltrageHistoEvt() {
	  document.getElementById("filtrageHistEvt").disabled = false;
      document.getElementById("selectionHistEvt").style.display = "inline";
   }
   
   function desactiverFiltrageContratService() {
      document.getElementById("filtrageContratService").disabled = true;
      document.getElementById("selectionContratService").style.display = "none";
   }
   function activerFiltrageContratService() {
      document.getElementById("selectionContratService").style.display = "inline";
      document.getElementById("filtrageContratService").disabled = false;
   }
   
   function testHeure() {
      if (document.getElementById("heureDebut").value == "24") {
         document.getElementById("minuteDebut").value = "00";
      }
      if (document.getElementById("heureFin").value == "24") {
         document.getElementById("minuteFin").value = "00";
      }
   }

   function majListeCodeEvtTech(mode) {
      var tab = document.getElementById("filtrageTechnique");
      if (mode == "garderTous") {
      	for (i=1; i < tab.length; i++) {
	      	tab[i].selected = false;
      	}
      } else if (mode == "effacerTous") {
         tab[0].selected = false;
      }
   }

   function majListeCodeEvtJournalEvt(mode) {
      var tab = document.getElementById("filtrageJournalEvt");
      if (mode == "garderTous") {
      	for (i=1; i < tab.length; i++) {
	      	tab[i].selected = false;
      	}
      } else if (mode == "effacerTous") {
         tab[0].selected = false;
      }
   }
   
//]]>
</script>
		
		

</head>

<body onload="initForm()">


<table class="ds_box" cellpadding="0" cellspacing="0" id="ds_conclass" style="display: none;">
	<tr>
		<td id="ds_calclass"></td>
	</tr>
</table>

<form:form method="post" modelAttribute="traceForm"
	action="lancerConsultTrace.do" onsubmit="return verificationForm()">

	<h6 class="msg_erreur" id="erreur"><form:errors path='*' /></h6>
	<c:if test="${stacktrace !=null}">
		<p><textarea class="stacktrace" rows="15" cols="180"><c:out value="${stacktrace}"/></textarea></p>
	</c:if>
	<c:if test="${detailTrace == null}">
	
	<div class="cadreForm">

	<p>Sélectionner le mode de recherche : </p>
	
	<form:radiobutton id="modeDate" path="modeRecherche" value="parDates" onchange="majListeDeroulante()"/>
	<label for="modeDate" class="inline">Par dates :</label>
	
	<table class="tableForm" cellpadding="0" cellspacing="0" >
	<tr class="tableForm">
	<td class="tableForm">
		
		<label for="dateDebut">Date début </label>
		</td><td>
		<form:input
			cssClass="inputDate" id="dateDebut" path="dateDebut" size="5" onclick="selectionnerParDates();"/>
			
			

	</td>
	<td><img src="./img/calendar.png" title="Voir le calendrier" alt="Voir le calendrier" onclick="selectionnerParDates();ds_sh(dateDebut);" onmouseover="this.style.cursor='pointer';"/></td>
	<td class="tableForm">
		
		<label for="heureDebut">Heure début </label>
		</td><td>
		<form:select cssClass="inputHeure" path="heureDebut" id="heureDebut" onchange="testHeure()">
			<form:option value="00" />
			<form:option value="01" />
			<form:option value="02" />
			<form:option value="03" />
			<form:option value="04" />
			<form:option value="05" />
			<form:option value="06" />
			<form:option value="07" />
			<form:option value="08" />
			<form:option value="09" />
			<form:option value="10" />
			<form:option value="11" />
			<form:option value="12" />
			<form:option value="13" />
			<form:option value="14" />
			<form:option value="15" />
			<form:option value="16" />
			<form:option value="17" />
			<form:option value="18" />
			<form:option value="19" />
			<form:option value="20" />
			<form:option value="21" />
			<form:option value="22" />
			<form:option value="23" />
			<form:option value="24" />
		</form:select>
		<form:select cssClass="inputHeure" path="minuteDebut" id="minuteDebut" onchange="testHeure()">
			<form:option value="00" />
			<form:option value="15" />
			<form:option value="30" />
			<form:option value="45" />
		</form:select>
			
	</td>
	<td class="tableForm"><label for="taille">Nb traces à récupérer :</label></td>
	<td><form:input cssClass="inputNum" id="taille" path="taille" /></td>
	
	</tr>
	<tr class="tableForm">
	<td class="tableForm">

		<label for="dateFin">Date fin </label> 
			</td><td>
		<form:input	cssClass="inputDate" id="dateFin" path="dateFin" size="5" onclick="selectionnerParDates();"/>
		
	</td>
	<td><img src="./img/calendar.png" title="Voir le calendrier" alt="Voir le calendrier" onclick="selectionnerParDates();ds_sh(dateFin);" onmouseover="this.style.cursor='pointer';"/></td>
	<td class="tableForm">

		<label for="heureFin">Heure fin </label>
			</td><td>
			<form:select cssClass="inputHeure" path="heureFin" id="heureFin" onchange="testHeure()">
			<form:option value="00" />
			<form:option value="01" />
			<form:option value="02" />
			<form:option value="03" />
			<form:option value="04" />
			<form:option value="05" />
			<form:option value="06" />
			<form:option value="07" />
			<form:option value="08" />
			<form:option value="09" />
			<form:option value="10" />
			<form:option value="11" />
			<form:option value="12" />
			<form:option value="13" />
			<form:option value="14" />
			<form:option value="15" />
			<form:option value="16" />
			<form:option value="17" />
			<form:option value="18" />
			<form:option value="19" />
			<form:option value="20" />
			<form:option value="21" />
			<form:option value="22" />
			<form:option value="23" />
			<form:option value="24" />
		</form:select>	
		<form:select cssClass="inputHeure" path="minuteFin" id="minuteFin" onchange="testHeure()">
			<form:option value="00" />
			<form:option value="15" />
			<form:option value="30" />
			<form:option value="45" />
		</form:select>
	</td>
	<td class="tableForm"><label for="ordreInverse">Ordre inverse :</label></td>
	<td><form:checkbox path="ordreInverse" id="ordreInverse"/></td>
	</tr>
	
	</table>

	

	<form:radiobutton id="modeIdentifiant" path="modeRecherche" value="parIdentifiant" onchange="majListeDeroulante()" />
	<label for="modeIdentifiant" class="inline">Par identifiant du document : </label> 
	<form:input id="idDoc" cssClass="inputText" path="idDoc" onclick="selectionnerParId()"/>
		
	<p class="double"></p>
	<p class="double">
		<label for="typeTrace">Type de traces :</label>
		<form:hidden path="listeTypeTrace" id="typeTraceHidden"/>
		<form:select
			id="typeTrace" path="listeTypeTrace" onchange="filtrage()">
			<form:options itemLabel="description" />
		</form:select>	
	</p>
	
	

	<div id="selectionTechnique">
		<p class="double">
			<label for="filtrageTechnique">Filtrage par code de l'évenement :</label>
			 <form:select id="filtrageTechnique" path="codeEvenement" multiple="true" size="6">
			 	<form:option value="TOUS" onclick="majListeCodeEvtTech('garderTous')">Tous</form:option>
			<c:forEach items="${codeEvtRegTechnique}" var="p">
				<form:option value="${p}" onclick="majListeCodeEvtTech('effacerTous')">${p}</form:option>
			</c:forEach>
			</form:select>
		</p>
	</div>
	<div id="selectionJournalEvt">
		<p class="double">
			<label for="filtrageJournalEvt">Filtrage par code de l'évenement :</label>
			 <form:select id="filtrageJournalEvt" path="codeEvenement" multiple="multiple" size="6">
			 	<form:option value="TOUS" onclick="majListeCodeEvtJournalEvt('garderTous')">Tous</form:option>
			<c:forEach items="${codeEvtJournalEvt}" var="p">
				<form:option value="${p}" onclick="majListeCodeEvtJournalEvt('effacerTous')">${p}</form:option>
			</c:forEach>
			</form:select>
		</p>
	</div>
    <div id="selectionContratService">
		<p class="double">
			<label for="filtrageContratService">Filtrage par contrat de service :</label>
			 <form:select id="filtrageContratService" path="contratService" >
			 	<form:option value="TOUS">Sélectionner...</form:option>
			<c:forEach items="${contratService}" var="p">
				<form:option value="${p}">${p}</form:option>
			</c:forEach>
			</form:select>
		</p>
	</div>
	<div id="selectionHistEvt">
		<p class="double">
			<label for="filtrageHistEvt">Filtrage par type de l'historique des événements DFCE :</label>
			 <form:select id="filtrageHistEvt" path="histEvtDfce" >
			 	<form:option value="TOUS">Sélectionner...</form:option>
			<c:forEach items="${listeHisEvtDfce}" var="p">
				<form:option value="${p}">${p}</form:option>
			</c:forEach>
			</form:select>
		</p>
	</div>

	<div style="padding-top: 5px"> Nombre de lignes dans le tableau résultat :
		<form:input cssClass="inputNum" size="3" id="nbLignesTableau" path="nbLignesTableau"/>
	</div>
	
<p style="text-align: right"><input type="submit" value="Consulter"/></p>
</div>
</c:if>

<c:if test="${listeTraces != null}">
<div style="overflow: scroll; padding-top: 15px">
	<display:table name="listeTraces" id="traceRow" requestURI="/lancerConsultTrace.do"
		 style="width: 90%"
		 defaultorder="descending" pagesize="${nbLignesTableau}">

	<c:if test="${modeAffichage == 'DFCE'}">
		<c:forEach items="${traceForm.colonnesAffichees}" var="colonne">
			<c:if test="${colonne == 'docUuid'}">
				<display:column title="Identifiant document" sortable="true">
					<a href="lancerConsultDoc.do?identifiant=${traceRow.docUuid}" title="Consulter le document">${traceRow.docUuid}</a>
				</display:column>
			</c:if>
			<c:if test="${colonne == 'dateEvt'}">
				<display:column property="dateEvt" title="Date"	sortable="true" format="{0,date,dd/MM/yyyy HH:mm}" />
			</c:if>
			<c:if test="${colonne == 'typeEvt'}">
				<display:column property="typeEvt" title="Type" sortable="true" />
			</c:if>
			<c:if test="${colonne == 'login'}">
				<display:column property="login" title="Login" sortable="true" />			
			</c:if>
			<c:if test="${colonne == 'attributs'}">
				<display:column title="Attributs" sortable="true" >
					<custom:map value="${traceRow.attributs}"></custom:map>
				</display:column>			
			</c:if>
			
		</c:forEach>
	</c:if>
	<c:if test="${modeAffichage == 'SAE'}">
		<c:forEach items="${traceForm.colonnesAffichees}" var="colonne">

			<c:if test="${colonne == 'action'}">
				<display:column property="action" title="Action" sortable="true" />			
			</c:if>
			<c:if test="${colonne == 'codeEvt'}">
				<display:column property="codeEvt" title="Code de l'évenement" sortable="true" />		
			</c:if>
			<c:if test="${colonne == 'contrat'}">
				<display:column property="contrat" title="Code du CS" sortable="true" />			
			</c:if>
			<c:if test="${colonne == 'login'}">
				<display:column property="login" title="Login" sortable="true" />			
			</c:if>
			<c:if test="${colonne == 'timestamp'}">
				<display:column property="timestamp" title="Date" sortable="true" format="{0,date,dd/MM/yyyy HH:mm:ss}" />
			</c:if>
			<c:if test="${colonne == 'contexte'}">
				<display:column property="contexte" title="Contexte" sortable="true" />
			</c:if>
			<c:if test="${colonne == 'pagms'}">
				<display:column title="PAGMS" sortable="true">
					<c:if test="${traceRow.pagms != '[]'}">${traceRow.pagms}</c:if> 
				</display:column>
			</c:if>
		</c:forEach>
		<display:column title="Détails" sortable="true" >
			<a href="detailTrace.do?idTrace=${traceRow.identifiant}&listeTypeTrace=${traceForm.listeTypeTrace}" title="Voir le détail" onclick="window.open(this.href); return false;">Détail</a>
			
		</display:column>
		
	</c:if>

	</display:table>	
</div>
</c:if>


<c:if test="${detailTrace != null}">
	<table>
	<c:forEach items="${traceForm.colonnesAffichees}" var="colonne">
		<c:if test="${colonne == 'action'}">
			<tr><td>Action</td><td>${detailTrace.action}</td></tr>
		</c:if>
		<c:if test="${colonne == 'codeEvt'}">
			<tr><td>Code de l'évenement</td><td>${detailTrace.codeEvt}</td></tr>
		</c:if>
		<c:if test="${colonne == 'contrat'}">
			<tr><td>Code du CS</td><td>${detailTrace.contrat}</td></tr>
		</c:if>
		<c:if test="${colonne == 'login'}">
			<tr><td>Login</td><td>${detailTrace.login}</td></tr>
		</c:if>
		<c:if test="${colonne == 'timestamp'}">
			<tr><td>Date</td><td><fmt:formatDate value="${detailTrace.timestamp}" pattern="dd/MM/yyyy HH:mm:ss.SSS" var="dateDetail" />
			${dateDetail}</td></tr>
		</c:if>
		<c:if test="${colonne == 'contexte'}">
			<tr><td>Contexte</td><td>${detailTrace.contexte}</td></tr>
		</c:if>
		<c:if test="${colonne == 'pagms'}">
			<tr><td>PAGMS</td><td>
				<c:if test="${detailTrace.pagms != '[]'}">${detailTrace.pagms}</c:if> 
			</td></tr>
		</c:if>
		<c:if test="${colonne == 'infos'}">
			<tr valign="top"><td >Infos</td><td><div><custom:map value="${detailTrace.infos}"></custom:map></div></td></tr>
		</c:if>
		<c:if test="${colonne == 'stacktrace'}">
			<tr><td valign="top">Stacktrace</td><td >${detailTrace.stacktrace}</td></tr>
		</c:if>
	</c:forEach>
	</table>   
</c:if>


</form:form>

</body>
</html>


