package fr.urssaf.image.sae.ihm.web.exploit.service.impl;

import java.io.IOException;
import java.io.InputStream;
import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.UUID;

import javax.activation.DataHandler;

import org.apache.commons.io.IOUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import fr.urssaf.image.sae.ihm.web.exploit.exception.AucunDocumentException;
import fr.urssaf.image.sae.ihm.web.exploit.exception.ErreurTechniqueException;
import fr.urssaf.image.sae.ihm.web.exploit.modele.Metadonnee;
import fr.urssaf.image.sae.ihm.web.exploit.modele.SaeDocument;
import fr.urssaf.image.sae.ihm.web.exploit.modele.SaeDonneesRecherche;
import fr.urssaf.image.sae.ihm.web.exploit.modele.SaeResultatRecherche;
import fr.urssaf.image.sae.ihm.web.exploit.saeservice.SaeStubUtils;
import fr.urssaf.image.sae.ihm.web.exploit.saeservice.modele.SaeServiceStub;
import fr.urssaf.image.sae.ihm.web.exploit.saeservice.modele.SaeServiceStub.Consultation;
import fr.urssaf.image.sae.ihm.web.exploit.saeservice.modele.SaeServiceStub.ConsultationRequestType;
import fr.urssaf.image.sae.ihm.web.exploit.saeservice.modele.SaeServiceStub.ConsultationResponseType;
import fr.urssaf.image.sae.ihm.web.exploit.saeservice.modele.SaeServiceStub.ListeMetadonneeCodeType;
import fr.urssaf.image.sae.ihm.web.exploit.saeservice.modele.SaeServiceStub.MetadonneeCodeType;
import fr.urssaf.image.sae.ihm.web.exploit.saeservice.modele.SaeServiceStub.MetadonneeType;
import fr.urssaf.image.sae.ihm.web.exploit.saeservice.modele.SaeServiceStub.Recherche;
import fr.urssaf.image.sae.ihm.web.exploit.saeservice.modele.SaeServiceStub.RechercheRequestType;
import fr.urssaf.image.sae.ihm.web.exploit.saeservice.modele.SaeServiceStub.RechercheResponseType;
import fr.urssaf.image.sae.ihm.web.exploit.saeservice.modele.SaeServiceStub.RequeteRechercheType;
import fr.urssaf.image.sae.ihm.web.exploit.saeservice.modele.SaeServiceStub.ResultatRechercheType;
import fr.urssaf.image.sae.ihm.web.exploit.saeservice.modele.SaeServiceStub.UuidType;
import fr.urssaf.image.sae.ihm.web.exploit.service.RechercherService;
import fr.urssaf.image.sae.ihm.web.exploit.utils.MetadonneesComparateur;
import fr.urssaf.image.sae.vi.service.WebServiceVICreateService;

/**
 * Classe implémentant le service Rechercher Service Ce service permet de
 * realiser des opérations de recherche sur un ou plusieurs document
 * 
 */
@Component
public class RechercherServiceImpl implements RechercherService {

   @Autowired
   private WebServiceVICreateService createService;
   
   /**
    * Renvoie la liste des documents satisfaisants à la requête lucène passée en
    * paramètre
    * 
    * @param requeteLucene
    *           Requête permettant de déterminer quels sont les documents à
    *           renvoyer
    * @param codes
    *           Liste des codes de métadonnées voulues à l'affichage
    * @param urlServiceWeb
    *           l'url du web service de la configuration choisie
    * @return Informations sur les documents satisfaisant à la requête lucène
    * 
    * @throws ErreurTechniqueException
    *            Exception levée lors d'une erreur technique
    * @throws AucunDocumentException
    *            Excpetion levée lorsque la recherche ne renvoie aucun document
    */
   @Override
   public final SaeResultatRecherche rechercherDocuments(String requeteLucene,
         List<String> codes, String urlServiceWeb)
         throws ErreurTechniqueException, AucunDocumentException {

      // Récupération du stub
      SaeStubUtils ssu = new SaeStubUtils();
      SaeServiceStub stub = ssu.getStub(urlServiceWeb, createService);

      // Création de la requête de recherche
      RechercheRequestType requestType = creationRequeteRecherche(
            requeteLucene, codes);

      // Lancement de la recherche
      try {
         RechercheResponseType reponse;
         reponse = appelWSRecherche(stub, requestType);

         ResultatRechercheType[] resultats = reponse.getResultats()
               .getResultat();

         // Exception si aucun résultat
         if (resultats == null) {
            throw new AucunDocumentException();
         }

         // Résultat tronqué ?
         boolean tronque = reponse.getResultatTronque();

         // Conversion du résultat en objet SaeDonneesRecherche
         List<SaeDonneesRecherche> listeDonneesRech = convertToSdr(resultats);
         return new SaeResultatRecherche(listeDonneesRech, tronque);

      } catch (RemoteException e) {
         throw new ErreurTechniqueException(e.getMessage());
      }
   }

   /**
    * Renvoie le document associé à l'uuid passé en paramètre
    * 
    * @param uuid
    *           Identifiant unique du document à chercher
    * @param codes
    *           Liste des codes de métadonnées voulues à l'affichage
    * @param urlServiceWeb
    *           l'url du service web de la configuration choisie
    * @param avecContenu
    *           indique si on récupère le contenu du document ou juste les
    *           métadonnées
    * @return Document recherché
    * 
    * @throws AucunDocumentException
    *            Exception levée lorsqu'aucun document n'est trouvé
    * @throws ErreurTechniqueException
    *            Exception levée lors d'une erreur technique
    */
   @Override
   public final SaeDocument consulterDocument(UUID uuid, List<String> codes,
         String urlServiceWeb, boolean avecContenu)
         throws AucunDocumentException, ErreurTechniqueException {

      // Récupération du Stub
      SaeStubUtils ssu = new SaeStubUtils();
      SaeServiceStub stub = ssu.getStub(urlServiceWeb, createService);

      // Création de la requête de consultation
      ConsultationRequestType consultRequestType = creationRequeteConsult(uuid,
            codes);

      try {
         // Lancement de la consultation
         ConsultationResponseType resultat = appelWSConsultation(stub,
               consultRequestType);

         // Exception si aucun résultat
         if (resultat == null) {
            throw new AucunDocumentException();
         }

         // Conversion du résultat en SaeDocument
         return convertToSD(resultat, avecContenu);

      } catch (RemoteException e) {
         throw new ErreurTechniqueException(e.getMessage());
      }
   }

   /**
    * Création requete pour l'appel WS de recherche
    * 
    * @param requeteLucene
    *           la requête lucène souhaitée pour la recherche
    * @param codes
    *           les codes des métadonnées à retourner par la recherche
    */
   private RechercheRequestType creationRequeteRecherche(String requeteLucene,
         List<String> codes) {

      RechercheRequestType requestType = new RechercheRequestType();

      // Requête Lucène
      RequeteRechercheType requete = new RequeteRechercheType();
      requete.setRequeteRechercheType(requeteLucene);
      requestType.setRequete(requete);

      // Métadonnées à afficher en retour
      MetadonneeCodeType[] tabMetaCodeType = null;
      if (codes != null) {
         tabMetaCodeType = new MetadonneeCodeType[codes.size()];
         int index = 0;
         for (String codeMeta : codes) {
            MetadonneeCodeType metaCodeType = new MetadonneeCodeType();
            metaCodeType.setMetadonneeCodeType(codeMeta);
            tabMetaCodeType[index] = metaCodeType;
            index++;
         }
      }
      ListeMetadonneeCodeType listeMeta = new ListeMetadonneeCodeType();
      listeMeta.setMetadonneeCode(tabMetaCodeType);
      requestType.setMetadonnees(listeMeta);

      return requestType;
   }

   /**
    * Appel au WS de recherche
    * 
    * @param stub
    * @param requestType
    *           la requête contenant la requete lucene et les métadonnées
    * @throws RemoteException
    */
   private RechercheResponseType appelWSRecherche(SaeServiceStub stub,
         RechercheRequestType requestType) throws RemoteException {
      Recherche recherche = new Recherche();
      recherche.setRecherche(requestType);
      return stub.recherche(recherche).getRechercheResponse();
   }

   /**
    *    
    */
   private List<SaeDonneesRecherche> convertToSdr(
         ResultatRechercheType[] resultats) {
      List<SaeDonneesRecherche> listeDonneesRech = new ArrayList<SaeDonneesRecherche>();
      for (ResultatRechercheType resRechType : resultats) {

         MetadonneeType[] metaType = resRechType.getMetadonnees()
               .getMetadonnee();

         List<Metadonnee> metadonnees = new ArrayList<Metadonnee>();
         for (int j = 0; j < metaType.length; j++) {
            Metadonnee meta = new Metadonnee(metaType[j].getCode()
                  .getMetadonneeCodeType(), metaType[j].getValeur()
                  .getMetadonneeValeurType(), "");
            metadonnees.add(meta);
         }

         String idArchivage = resRechType.getIdArchive().getUuidType();
         UUID uuid = UUID.fromString(idArchivage);

         // Tri des métadonnées par ordre alphabétique du code
         Collections.sort(metadonnees, new MetadonneesComparateur());

         SaeDonneesRecherche sdr = new SaeDonneesRecherche(metadonnees, uuid);
         listeDonneesRech.add(sdr);
      }
      return listeDonneesRech;
   }

   /**
    * Création de la requete de consultation
    * 
    * @param uuid
    *           uuid du document à consulter
    * @param codes
    *           liste des métadonnées à retourner par la consultation
    * @return
    */
   private ConsultationRequestType creationRequeteConsult(UUID uuid,
         List<String> codes) {
      ConsultationRequestType consultRequestType = new ConsultationRequestType();

      // UUID
      UuidType uuidType = new UuidType();
      uuidType.setUuidType(uuid.toString());
      consultRequestType.setIdArchive(uuidType);

      // Métadonnées à afficher en retour
      if (codes != null) {
         MetadonneeCodeType[] tabMetaCodeType = new MetadonneeCodeType[codes
               .size()];
         int index = 0;
         for (String codeMeta : codes) {
            MetadonneeCodeType metaCodeType = new MetadonneeCodeType();
            metaCodeType.setMetadonneeCodeType(codeMeta);
            tabMetaCodeType[index] = metaCodeType;
            index++;
         }
         ListeMetadonneeCodeType listeMeta = new ListeMetadonneeCodeType();
         listeMeta.setMetadonneeCode(tabMetaCodeType);
         consultRequestType.setMetadonnees(listeMeta);
      }

      return consultRequestType;
   }

   /**
    * Appel au WS de consultation
    * 
    * @param stub
    * @param ConsultationRequestType
    *           la requête contenant l'uuid et les métadonnées
    * @throws RemoteException
    */
   private ConsultationResponseType appelWSConsultation(SaeServiceStub stub,
         ConsultationRequestType consultRequestType) throws RemoteException {

      Consultation consultation = new Consultation();
      consultation.setConsultation(consultRequestType);
      return stub.consultation(consultation).getConsultationResponse();
   }

   private SaeDocument convertToSD(ConsultationResponseType resultat,
         boolean avecContenu) throws ErreurTechniqueException {
      // Métadonnées retournée
      MetadonneeType[] metaType = resultat.getMetadonnees().getMetadonnee();
      List<Metadonnee> metadonnees = new ArrayList<Metadonnee>();
      for (int j = 0; j < metaType.length; j++) {
         Metadonnee meta = new Metadonnee(metaType[j].getCode()
               .getMetadonneeCodeType(), metaType[j].getValeur()
               .getMetadonneeValeurType(), "");
         metadonnees.add(meta);
      }
      // Tri des métadonnées par ordre alphabétique du code
      Collections.sort(metadonnees, new MetadonneesComparateur());

      if (avecContenu) {
         try {
            DataHandler data = resultat.getObjetNumerique()
                  .getObjetNumeriqueConsultationTypeChoice_type0().getContenu();
            InputStream inStream;
            inStream = data.getInputStream();
            byte[] contenu = IOUtils.toByteArray(inStream);
            inStream.close();
            return new SaeDocument(metadonnees, contenu);
         } catch (IOException e) {
            throw new ErreurTechniqueException(e.getMessage());
         }
      } else {
         return new SaeDocument(metadonnees, null);
      }
   }
}
