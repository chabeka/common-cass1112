package fr.urssaf.image.sae.ihm.web.exploit.service.impl;

import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import java.util.UUID;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;

import fr.urssaf.image.commons.dfce.model.DFCEConnection;
import fr.urssaf.image.commons.dfce.service.DFCEConnectionService;
import fr.urssaf.image.commons.dfce.service.impl.DFCEConnectionServiceImpl;
import fr.urssaf.image.sae.ihm.web.exploit.modele.ChainageDisplay;
import fr.urssaf.image.sae.ihm.web.exploit.modele.JournalDisplay;
import fr.urssaf.image.sae.ihm.web.exploit.service.JournauxService;
import fr.urssaf.image.sae.trace.dao.model.Chainage;
import fr.urssaf.image.sae.trace.dao.model.Journal;
import fr.urssaf.image.sae.trace.dao.support.JournalDfceSupport;
import fr.urssaf.image.sae.trace.dao.support.JournalSaeSupport;
import fr.urssaf.image.sae.trace.dao.support.ServiceProviderSupport;
import fr.urssaf.image.sae.trace.model.JournalType;
import fr.urssaf.image.sae.trace.service.JournalService;
import fr.urssaf.image.sae.trace.service.impl.JournalServiceImpl;

/**
 * Implémentation du service {@link}Journaux Service
 * 
 * 
 */
@Service
public class JournauxServiceImpl implements JournauxService {

   private static final String FIN_LOG = "{} - fin";
   private static final String DEBUT_LOG = "{} - début";
   private static final Logger LOGGER = LoggerFactory
         .getLogger(JournauxServiceImpl.class);

   /**
    * Service permettant de réaliser des opérations sur les journaux
    */
   private JournalService journalService;

   @Override
   public final List<JournalDisplay> rechercherJournauxDocument(UUID uuidDoc,
         DFCEConnection dfceConnection) {

      String trcPrefix = "rechercherJournauxDocument";
      LOGGER.debug(DEBUT_LOG, trcPrefix);

      LOGGER.debug("{} - UUID Doc : {}", new String[] { trcPrefix,
            uuidDoc.toString() });
      LOGGER.debug("{} - Connexion DFCE : {}", new String[] { trcPrefix,
            dfceConnection.getServerUrl().toString() });

      ServiceProviderSupport serviceProvider = connectToDFCeProvider(dfceConnection);

      JournalDfceSupport journalDfceSupport = new JournalDfceSupport(
            serviceProvider);
      JournalSaeSupport journalSaeSupport = new JournalSaeSupport(
            serviceProvider);
      journalService = new JournalServiceImpl(journalDfceSupport,
            journalSaeSupport);
      List<Journal> liste = journalService.rechercherJournauxDocument(uuidDoc);

      List<JournalDisplay> listeJournaux = new ArrayList<JournalDisplay>();

      for (Journal journal : liste) {

         /**
          * Conversion de la taille en unité lisible
          */
         long tailleFichier = journal.getTaille();
         String tailleAffichable = conversionTaille(tailleFichier);

         JournalDisplay journalDisplay = new JournalDisplay(journal.getDate(),
               journal.getIdentifiant(), journal.getNomFichier(), journal
               .getDateDebutEvt(), journal.getDateFinEvt(),
               tailleAffichable);
         listeJournaux.add(journalDisplay);
      }
      serviceProvider.disconnect();
      LOGGER.debug(FIN_LOG, trcPrefix);
      return listeJournaux;
   }


   @Override
   public final List<JournalDisplay> rechercherJournauxEvenementDfce(
         Date dateDebut, Date dateFin, DFCEConnection dfceConnection) {

      String trcPrefix = "rechercherJournauxEvenementDfce";
      LOGGER.debug(DEBUT_LOG, trcPrefix);
      LOGGER.debug("{} - Date début : {}", new String[] { trcPrefix,
            dateDebut.toString() });
      LOGGER.debug("{} - Date fin : {}", new String[] { trcPrefix,
            dateFin.toString() });
      LOGGER.debug("{} - Connexion DFCE : {}", new String[] { trcPrefix,
            dfceConnection.getServerUrl().toString() });

      ServiceProviderSupport serviceProvider = connectToDFCeProvider(dfceConnection);

      JournalDfceSupport journalDfceSupport = new JournalDfceSupport(
            serviceProvider);
      JournalSaeSupport journalSaeSupport = new JournalSaeSupport(
            serviceProvider);
      journalService = new JournalServiceImpl(journalDfceSupport,
            journalSaeSupport);

      List<Journal> liste = journalService.rechercherJournauxEvenementDfce(
            dateDebut, dateFin);

      List<JournalDisplay> listeJournaux = new ArrayList<JournalDisplay>();

      for (Journal journal : liste) {

         /**
          * Conversion de la taille en unité lisible
          */
         long tailleFichier = journal.getTaille();
         String tailleAffichable = conversionTaille(tailleFichier);

         JournalDisplay journalDisplay = new JournalDisplay(journal.getDate(),
               journal.getIdentifiant(), journal.getNomFichier(), journal
               .getDateDebutEvt(), journal.getDateFinEvt(),
               tailleAffichable);
         listeJournaux.add(journalDisplay);
      }
      serviceProvider.disconnect();
      LOGGER.debug(FIN_LOG, trcPrefix);
      return listeJournaux;
   }

   @Override
   public final JournalDisplay rechercherJournauxDfce(UUID uuidJournal,
         DFCEConnection dfceConnection) {

      String trcPrefix = "rechercherJournauxEvenementDfce";
      LOGGER.debug(DEBUT_LOG, trcPrefix);
      LOGGER.debug("{} - UUID Journal : {}", new String[] { trcPrefix,
            uuidJournal.toString() });
      LOGGER.debug("{} - Connexion DFCE : {}", new String[] { trcPrefix,
            dfceConnection.getServerUrl().toString() });

      ServiceProviderSupport serviceProvider = connectToDFCeProvider(dfceConnection);

      JournalDfceSupport journalDfceSupport = new JournalDfceSupport(
            serviceProvider);
      JournalSaeSupport journalSaeSupport = new JournalSaeSupport(
            serviceProvider);
      journalService = new JournalServiceImpl(journalDfceSupport,
            journalSaeSupport);

      Journal journal = journalService.rechercherJournauxDfce(uuidJournal);

      serviceProvider.disconnect();

      /**
       * Conversion de la taille en unité lisible
       */
      if (journal != null) {
         long tailleFichier = journal.getTaille();
         String tailleAffichable = conversionTaille(tailleFichier);

         JournalDisplay journalDisplay = new JournalDisplay(journal.getDate(),
               journal.getIdentifiant(), journal.getNomFichier(), journal
               .getDateDebutEvt(), journal.getDateFinEvt(), tailleAffichable);
         LOGGER.debug(FIN_LOG, trcPrefix);
         return journalDisplay;
      } else {
         LOGGER.debug(FIN_LOG, trcPrefix);
         return null;
      }




   }

   @Override
   public final List<JournalDisplay> rechercherJournauxCycleVie(Date dateDebut,
         Date dateFin, DFCEConnection dfceConnection) {

      String trcPrefix = "rechercherJournauxCycleVie";
      LOGGER.debug("{} - début", trcPrefix);
      LOGGER.debug("{} - Date début : {}", new String[] { trcPrefix,
            dateDebut.toString() });
      LOGGER.debug("{} - Date fin : {}", new String[] { trcPrefix,
            dateFin.toString() });
      LOGGER.debug("{} - Connexion DFCE : {}", new String[] { trcPrefix,
            dfceConnection.getServerUrl().toString() });

      ServiceProviderSupport serviceProvider = connectToDFCeProvider(dfceConnection);

      JournalDfceSupport journalDfceSupport = new JournalDfceSupport(
            serviceProvider);
      JournalSaeSupport journalSaeSupport = new JournalSaeSupport(
            serviceProvider);
      journalService = new JournalServiceImpl(journalDfceSupport,
            journalSaeSupport);

      List<Journal> liste = journalService.rechercherJournauxCycleVie(
            dateDebut, dateFin);

      List<JournalDisplay> listeJournaux = new ArrayList<JournalDisplay>();

      for (Journal journal : liste) {
         /**
          * Conversion de la taille en unité lisible
          */
         long tailleFichier = journal.getTaille();
         String tailleAffichable = conversionTaille(tailleFichier);

         JournalDisplay journalDisplay = new JournalDisplay(journal.getDate(),
               journal.getIdentifiant(), journal.getNomFichier(), journal
               .getDateDebutEvt(), journal.getDateFinEvt(),
               tailleAffichable);
         listeJournaux.add(journalDisplay);
      }
      serviceProvider.disconnect();
      LOGGER.debug("{} - fin", trcPrefix);
      return listeJournaux;
   }

   /**
    * Conversion de la taille en donnée viualisable (Ko, Mo, Go)
    * 
    * @param tailleFichier
    * @return
    */
   private String conversionTaille(long tailleFichier) {
      long tailleKo = tailleFichier / 1024;
      long tailleMo = tailleKo / 1024;
      long tailleGo = tailleMo / 1024;
      String tailleAffichable = "";
      if (tailleGo > 0) {
         tailleAffichable = tailleGo + " Go";
      } else if (tailleMo > 0) {
         tailleAffichable = tailleMo + " Mo";
      } else if (tailleKo > 0) {
         tailleAffichable = tailleKo + " Ko";
      } else {
         tailleAffichable = tailleFichier + " o";
      }
      return tailleAffichable;
   }

   @Override
   public final List<JournalDisplay> rechercherJournauxEvenementSae(
         Date dateDebut, Date dateFin, DFCEConnection dfceConnection,
         String nomBase) {

      String trcPrefix = "rechercherJournauxEvenementSae";
      LOGGER.debug(DEBUT_LOG, trcPrefix);
      LOGGER.debug("{} - Date début : {}", new String[] { trcPrefix,
            dateDebut.toString() });
      LOGGER.debug("{} - Date fin : {}", new String[] { trcPrefix,
            dateFin.toString() });
      LOGGER.debug("{} - Connexion DFCE : {}", new String[] { trcPrefix,
            dfceConnection.getServerUrl().toString() });
      LOGGER.debug("{} - Nom de la base : {}", new String[] { trcPrefix,
            nomBase });

      ServiceProviderSupport serviceProvider = connectToDFCeProvider(dfceConnection);

      JournalDfceSupport journalDfceSupport = new JournalDfceSupport(
            serviceProvider);
      JournalSaeSupport journalSaeSupport = new JournalSaeSupport(
            serviceProvider);
      journalService = new JournalServiceImpl(journalDfceSupport,
            journalSaeSupport);

      List<Journal> liste = journalService.rechercherJournauxEvenementSae(
            dateDebut, dateFin, nomBase);

      List<JournalDisplay> listeJournaux = new ArrayList<JournalDisplay>();

      for (Journal journal : liste) {
         long tailleFichier = journal.getTaille();
         String tailleAffichable = conversionTaille(tailleFichier);
         JournalDisplay journalDisplay = new JournalDisplay(journal.getDate(),
               journal.getIdentifiant(), journal.getNomFichier(), journal
               .getDateDebutEvt(), journal.getDateFinEvt(),
               tailleAffichable);
         listeJournaux.add(journalDisplay);
      }

      serviceProvider.disconnect();
      LOGGER.debug(FIN_LOG, trcPrefix);
      return listeJournaux;
   }

   @Override
   public final List<ChainageDisplay> verifierChainage(Date dateDebut,
         Date dateFin, JournalType journalType, DFCEConnection dfceConnection) {

      String trcPrefix = "verifierChainage";
      LOGGER.debug(DEBUT_LOG, trcPrefix);

      LOGGER.debug("{} - Date début : {}", new String[] { trcPrefix,
            dateDebut.toString() });
      LOGGER.debug("{} - Date fin : {}", new String[] { trcPrefix,
            dateFin.toString() });
      LOGGER.debug("{} - Type de journal : {}", new String[] { trcPrefix,
            journalType.toString() });
      LOGGER.debug("{} - Connexion DFCE : {}", new String[] { trcPrefix,
            dfceConnection.getServerUrl().toString() });

      ServiceProviderSupport serviceProvider = connectToDFCeProvider(dfceConnection);

      JournalDfceSupport journalDfceSupport = new JournalDfceSupport(
            serviceProvider);
      JournalSaeSupport journalSaeSupport = new JournalSaeSupport(
            serviceProvider);
      journalService = new JournalServiceImpl(journalDfceSupport,
            journalSaeSupport);
      List<Chainage> liste = journalService.verifierChainage(dateDebut,
            dateFin, journalType);

      List<ChainageDisplay> listeChainage = new ArrayList<ChainageDisplay>();
      for (Chainage chainage : liste) {
         ChainageDisplay chainageDisplay = new ChainageDisplay();
         chainageDisplay.setAlgoHash(chainage.getAlgoHash());
         chainageDisplay.setDateFin(chainage.getDateFin());
         chainageDisplay.setHash(chainage.getHash());
         chainageDisplay.setHashRecalcule(chainage.getHashRecalcule());
         chainageDisplay.setUuidPrecedentJournal(chainage
               .getUuidPrecedentJournal());
         listeChainage.add(chainageDisplay);
      }
      serviceProvider.disconnect();
      LOGGER.debug(FIN_LOG, trcPrefix);
      return listeChainage;

   }

   @Override
   public final byte[] recupererContenuJournalDfce(UUID uuidJournal,
         DFCEConnection dfceConnection) {

      String trcPrefix = "recupererContenuJournalDfce";
      LOGGER.debug(DEBUT_LOG, trcPrefix);
      LOGGER.debug("{} - UUID Journal : {}", new String[] { trcPrefix,
            uuidJournal.toString() });
      LOGGER.debug("{} - Connexion DFCE : {}", new String[] { trcPrefix,
            dfceConnection.getServerUrl().toString() });

      ServiceProviderSupport serviceProvider = connectToDFCeProvider(dfceConnection);

      JournalDfceSupport journalDfceSupport = new JournalDfceSupport(
            serviceProvider);
      JournalSaeSupport journalSaeSupport = new JournalSaeSupport(
            serviceProvider);
      journalService = new JournalServiceImpl(journalDfceSupport,
            journalSaeSupport);

      byte[] contenu = journalService.recupererContenuJournalDfce(uuidJournal);
      serviceProvider.disconnect();
      LOGGER.debug(FIN_LOG, trcPrefix);

      return contenu;

   }

   @Override
   public final byte[] recupererContenuJournalSae(UUID uuidJournal,
         DFCEConnection dfceConnection, String nomBase) {

      String trcPrefix = "recupererContenuJournalSae";
      LOGGER.debug("DEBUT_LOG", trcPrefix);
      LOGGER.debug("{} - UUID Journal : {}", new String[] { trcPrefix,
            uuidJournal.toString() });
      LOGGER.debug("{} - Connexion DFCE : {}", new String[] { trcPrefix,
            dfceConnection.getServerUrl().toString() });
      LOGGER.debug("{} - Connexion DFCE : {}", new String[] { trcPrefix,
            nomBase });

      ServiceProviderSupport serviceProvider = connectToDFCeProvider(dfceConnection);

      JournalDfceSupport journalDfceSupport = new JournalDfceSupport(
            serviceProvider);
      JournalSaeSupport journalSaeSupport = new JournalSaeSupport(
            serviceProvider);
      journalService = new JournalServiceImpl(journalDfceSupport,
            journalSaeSupport);

      byte[] contenu = journalService.recupererContenuJournalSae(uuidJournal,
            nomBase);

      serviceProvider.disconnect();
      LOGGER.debug(FIN_LOG, trcPrefix);
      return contenu;
   }

   @Override
   public final String getNomJournalDfce(UUID uuidJournal,
         DFCEConnection dfceConnection) {
      String trcPrefix = "getNomJournalDfce";
      LOGGER.debug("{} - début", trcPrefix);

      ServiceProviderSupport serviceProvider = connectToDFCeProvider(dfceConnection);

      JournalDfceSupport journalDfceSupport = new JournalDfceSupport(
            serviceProvider);
      JournalSaeSupport journalSaeSupport = new JournalSaeSupport(
            serviceProvider);
      journalService = new JournalServiceImpl(journalDfceSupport,
            journalSaeSupport);

      String nomFichier = journalService.getNomJournalDfce(uuidJournal);

      LOGGER.debug("{} - fin", trcPrefix);
      return nomFichier;
   }

   @Override
   public JournalDisplay rechercherJournauxEvenementSae(UUID uuidJournal,
         DFCEConnection dfceConnection, String nomBase) {
      String trcPrefix = "rechercherJournauxEvenementSae";
      LOGGER.debug(DEBUT_LOG, trcPrefix);
      LOGGER.debug("{} - UUID Journal : {}", new String[] { trcPrefix,
            uuidJournal.toString() });
      LOGGER.debug("{} - Connexion DFCE : {}", new String[] { trcPrefix,
            dfceConnection.getServerUrl().toString() });
      LOGGER.debug("{} - Nom de la base : {}", new String[] { trcPrefix,
            nomBase });

      ServiceProviderSupport serviceProvider = connectToDFCeProvider(dfceConnection);

      JournalDfceSupport journalDfceSupport = new JournalDfceSupport(
            serviceProvider);
      JournalSaeSupport journalSaeSupport = new JournalSaeSupport(
            serviceProvider);
      journalService = new JournalServiceImpl(journalDfceSupport,
            journalSaeSupport);

      Journal journal = journalService.rechercherJournauxEvenementSae(
            uuidJournal, nomBase);

      serviceProvider.disconnect();

      if (journal != null) {
         long tailleFichier = journal.getTaille();
         String tailleAffichable = conversionTaille(tailleFichier);
         JournalDisplay journalDisplay = new JournalDisplay(journal.getDate(),
               journal.getIdentifiant(), journal.getNomFichier(), journal
               .getDateDebutEvt(), journal.getDateFinEvt(), tailleAffichable);
         LOGGER.debug(FIN_LOG, trcPrefix);
         return journalDisplay;
      } else {
         LOGGER.debug(FIN_LOG, trcPrefix);
         return null;
      }

   }

   /**
    * Methode permettant de se connecter à DFCe.
    * 
    * @param dfceConnection
    *           Parametres de connection.
    * @return le service de connection à DFCe
    */
   private ServiceProviderSupport connectToDFCeProvider(
         DFCEConnection dfceConnection) {
      DFCEConnectionService dfceConnectionService = new DFCEConnectionServiceImpl(
            dfceConnection);
      ServiceProviderSupport serviceProvider = new ServiceProviderSupport(
            dfceConnection, dfceConnectionService);
      serviceProvider.connect();
      return serviceProvider;
   }
}
