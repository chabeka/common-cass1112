package fr.urssaf.image.sae.ihm.web.exploit.controller;

import java.io.PrintWriter;
import java.io.StringWriter;
import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;

import me.prettyprint.hector.api.Keyspace;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;

import com.netflix.curator.framework.CuratorFramework;

import fr.urssaf.image.sae.ihm.web.exploit.modele.ConfigurationsEnvironnement;
import fr.urssaf.image.sae.ihm.web.exploit.modele.EtatJobSAE;
import fr.urssaf.image.sae.ihm.web.exploit.service.EtatJobsService;
import fr.urssaf.image.sae.ihm.web.exploit.service.impl.EtatJobsServiceImpl;

/**
 * Classe permettant de gérer l'etat des jobs
 * 
 * 
 */
@Controller
public class EtatJobsController {
   
   @Autowired
   private ConfigurationsEnvironnement config;
   
   /**
    * Recuperes l'etat des jobs SAE
    * 
    * @param model
    *           le modèle
    * @param session
    *           la session
    * @param request
    *           la requête
    * @return la page à afficher
    * @throws InterruptedException
    *            Exception
    */
   @RequestMapping(value = "etatJobsSAE", method = RequestMethod.GET)
   public final String etatJobsSAE(Model model, HttpSession session,
         HttpServletRequest request) throws InterruptedException {
      
      try {
         // Récupération de la configuration choisie
         String nomConf = (String) session.getAttribute("nomConfiguration");
         Keyspace keyspace = (Keyspace) session.getServletContext()
               .getAttribute(nomConf);
         CuratorFramework curator = (CuratorFramework) session
               .getServletContext().getAttribute(nomConf + "-zookeeper");
         
         EtatJobsService etatJobsService = new EtatJobsServiceImpl(keyspace,
               config, curator);
         
         List<EtatJobSAE> etatJobsSae = etatJobsService.getEtatJobsSAE();
         request.setAttribute("etatJobsSae", etatJobsSae);
         
      } catch (Exception e) {
         StringWriter sw = new StringWriter();
         PrintWriter pw = new PrintWriter(sw);
         e.printStackTrace(pw);
         String stacktrace = sw.toString();
         request.setAttribute("stacktrace", stacktrace);
      }

      return "etatJobsSAE";

   }
}
