package fr.urssaf.image.sae.ihm.web.exploit.controller;

import java.util.ArrayList;
import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;
import javax.validation.Valid;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.validation.BindingResult;
import org.springframework.validation.ObjectError;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;

import fr.urssaf.image.sae.ihm.web.exploit.exception.AucunDocumentException;
import fr.urssaf.image.sae.ihm.web.exploit.exception.ErreurTechniqueException;
import fr.urssaf.image.sae.ihm.web.exploit.formulaire.RechercherDocumentsForm;
import fr.urssaf.image.sae.ihm.web.exploit.modele.ConfigurationEnvironnement;
import fr.urssaf.image.sae.ihm.web.exploit.modele.ConfigurationsEnvironnement;
import fr.urssaf.image.sae.ihm.web.exploit.modele.Metadonnee;
import fr.urssaf.image.sae.ihm.web.exploit.modele.Metadonnees;
import fr.urssaf.image.sae.ihm.web.exploit.modele.SaeDonneesRecherche;
import fr.urssaf.image.sae.ihm.web.exploit.modele.SaeResultatRecherche;
import fr.urssaf.image.sae.ihm.web.exploit.service.RechercherService;

/**
 * Classe centralisant les opérations utilisateurs pour la recherche de
 * documents
 * 
 * 
 */
@Controller
@RequestMapping(value = "rechercherDocuments")
public class RechercherDocumentController {

   /**
    * Service offrant les opérations de recherche sur un ou plusieurs documents
    */
   @Autowired
   private RechercherService rechercherService;

   /**
    * Liste des métadonnées qui peuvent être utilisée comme critère de recherche
    */
   @Autowired
   private Metadonnees metadonneesRecherche;

   /**
    * Liste des métadonnées qui peuvent être affichées au retour
    */
   @Autowired
   private Metadonnees metadonneesAffichage;

   /**
    * Liste des environnements disponibles pour effectuer les opérations
    */
   @Autowired
   private ConfigurationsEnvironnement environnements;

   /**
    * Initialisation du formulaire de recherche de documents
    * 
    * @param model
    *           le modèle
    * @param session
    *           la session
    * @param request
    *           la requête
    * @return la page à afficher
    * @throws InterruptedException
    *            l'exception levée
    */
   @RequestMapping(method = RequestMethod.GET)
   public final String initialisation(Model model, HttpSession session,
         HttpServletRequest request) throws InterruptedException {

      // Préparation de la liste des métadonnées disponibles en recherche
      request.setAttribute("listeMetaRecherche", metadonneesRecherche
            .getMetadonnees());
      // Préparation de la liste des métadonnées disponibles pour la
      // consultation
      request.setAttribute("listeMetaAffichage", metadonneesAffichage
            .getMetadonnees());

      RechercherDocumentsForm form = new RechercherDocumentsForm();
      model.addAttribute("rechercheForm", form);

      return "rechercherDocuments";

   }

   /**
    * Lance la recherche de documents
    * 
    * @param rechercheForm
    *           le formulaire
    * @param result
    *           gestion des erreurs
    * @param session
    *           la session
    * @param request
    *           la requête
    * @return la page à afficher
    */
   @RequestMapping(method = RequestMethod.POST)
   public final String rechercherDocuments(
         @ModelAttribute("rechercheForm") @Valid RechercherDocumentsForm rechercheForm,
         BindingResult result, HttpSession session, HttpServletRequest request) {

      if (!result.hasFieldErrors()) {
         try {
            SaeResultatRecherche srr;
            // Récupération de la requête Lucène
            String requeteLucene = rechercheForm.getRequeteLucene();
            // Récupération des métadonnées à afficher en retour
            List<String> codesMeta = rechercheForm.getCodeMeta();

            // Récupération de l'url du webservice
            String nomConf = (String) session.getAttribute("nomConfiguration");
            ConfigurationEnvironnement conf = environnements
                  .getConfiguration(nomConf);
            String urlServiceWeb = conf.getUrlWs().toString();

            // Lancement de la recherche
            srr = rechercherService.rechercherDocuments(requeteLucene,
                  codesMeta, urlServiceWeb);

            request.setAttribute("resRecherche", srr);

            // Noms des colonnes à afficher
            List<SaeDonneesRecherche> sdr = srr.getDonnees();
            List<String> entete = new ArrayList<String>();
            List<Metadonnee> listeMeta = sdr.get(0).getMetadonnees();
            for (Metadonnee meta : listeMeta) {
               entete.add(meta.getCode());
            }
            request.setAttribute("entete", entete);

         } catch (ErreurTechniqueException e) {
            ObjectError erreur = new ObjectError("rechercheForm", e
                  .getMessage());
            result.addError(erreur);
         } catch (AucunDocumentException e) {
            ObjectError erreur = new ObjectError("rechercheForm",
                  "Cette requête n'a retourné aucun résultat");
            result.addError(erreur);
         }

      }
      // Préparation de la liste des métadonnées disponibles en recherche
      request.setAttribute("listeMetaRecherche", metadonneesRecherche
            .getMetadonnees());
      // Préparation de la liste des métadonnées disponibles pour la
      // consultation
      request.setAttribute("listeMetaAffichage", metadonneesAffichage
            .getMetadonnees());

      return "rechercherDocuments";
   }

}
