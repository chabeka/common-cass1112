package fr.urssaf.image.sae.ihm.web.exploit.controller;

import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import java.util.UUID;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;
import javax.validation.Valid;

import me.prettyprint.hector.api.Keyspace;

import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.validation.BindingResult;
import org.springframework.validation.ObjectError;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.RequestMapping;

import fr.urssaf.image.sae.ihm.web.exploit.exception.AucunJobException;
import fr.urssaf.image.sae.ihm.web.exploit.exception.MiseAJourJobException;
import fr.urssaf.image.sae.ihm.web.exploit.formulaire.GererPileTravauxForm;
import fr.urssaf.image.sae.ihm.web.exploit.service.GererPileService;
import fr.urssaf.image.sae.pile.travaux.model.JobRequest;

/**
 * Classe centralisant les opérations utilsateur pour la manipulation de la pile
 * des travaux
 * 
 * 
 */
@Controller
public class GererPileTravauxController {

   /**
    * Service permettant de réaliser les opérations sur la pile des travaux
    */
   @Autowired
   private GererPileService gererPileService;

   /**
    * Initialisation de l'écran de consultation/gestion de la pile des travaux
    * @param gererPileTravauxForm Formulaire de gestion de la pile
    * @param result Result
    * @param session Session
    * @param request Request
    * @return la page à afficher
    */
   @SuppressWarnings("unchecked")
   @RequestMapping(value = {"consulterPile","gererPile"})
   public final String initialisation(
         @ModelAttribute("gererPileTravauxForm") @Valid GererPileTravauxForm gererPileTravauxForm,
         BindingResult result, HttpSession session, HttpServletRequest request) {

      // Récupération de la configuration choisie
      String nomConf = (String) session.getAttribute("nomConfiguration");
      Keyspace keyspace = (Keyspace) session.getServletContext().getAttribute(
            nomConf);

      // Récupération des droits de l'utilisateur
      List<String> listePagm = (List<String>) session.getAttribute("pagmList");

      // Liste des noms des colonnes
      List<String> colonnes = new ArrayList<String>();
      colonnes.add("type");
      colonnes.add("parameters");
      colonnes.add("state");
      colonnes.add("creationDate");
      colonnes.add("saeHost");
      colonnes.add("clientHost");
      colonnes.add("docCount");
      colonnes.add("reservationDate");
      colonnes.add("reservedBy");
      colonnes.add("startingDate");
      colonnes.add("pid");
      colonnes.add("endingDate");
      colonnes.add("message");
      colonnes.add("toCheckFlag");
      colonnes.add("toCheckFlagRaison");
      request.setAttribute("colonnes", colonnes);

      // Mode affichage
      String modeAffichage = gererPileTravauxForm.getModeAffichage();

      if (StringUtils.isBlank(modeAffichage)) {
         // Par défaut
         modeAffichage = "minimal";
         gererPileTravauxForm.setModeAffichage(modeAffichage);
      }
      
      // Colonnes à afficher
      List<String> colonnesAffichees = new ArrayList<String>();
      if ("minimal".equals(modeAffichage)) {
         colonnesAffichees.add("type");
         colonnesAffichees.add("parameters");
         colonnesAffichees.add("state");
      } else if ("personnalise".equals(modeAffichage)) {
         List<String> colonnesChoisies = gererPileTravauxForm
               .getColonnesAffichees();
         if (colonnesChoisies == null) {
            colonnesAffichees.add("type");
            colonnesAffichees.add("parameters");
            colonnesAffichees.add("state");
         } else {
            colonnesAffichees = colonnesChoisies;
         }
      } else if ("complet".equals(modeAffichage)) {
         colonnesAffichees = colonnes;
      }
      
      gererPileTravauxForm.setColonnesAffichees(colonnesAffichees);

      // Si pas d'erreur dans le formulaire, on fait la recherche et/ou le
      // filtrage des jobs
      if (!result.hasFieldErrors()) {

         // Suppression de job
         String action = request.getParameter("bouton_validation");
         try {
            if ("Supprimer".equals(action)) {
               UUID idATraiter = gererPileTravauxForm.getIdentifiantATraiter();
               gererPileService.supprimerTravail(idATraiter, keyspace);
            }
         
            // Remise en état de relance d'un job
            if ("Relancer".equals(action)) {
               UUID idATraiter = gererPileTravauxForm.getIdentifiantATraiter();
               gererPileService.remettreTravailEtatLancement(idATraiter, keyspace);            
            }
         } catch (MiseAJourJobException e) {
            ObjectError erreur = new ObjectError("rechercheForm", e
                  .getMessage());
            result.addError(erreur);
         } catch (AucunJobException e) {
            ObjectError erreur = new ObjectError("rechercheForm",
                  "Le job n'existe pas !");
            result.addError(erreur);
         }
         
           
         // Si on ne vient pas du formulaire de filtrage,
         // on récupère les jobs en base
         // Sinon on utilise ceux en session
         List<JobRequest> listeJobs = (List<JobRequest>) session
               .getAttribute("listeJobs");
         if (!"Filtrer".equals(action) || listeJobs == null) {
            // Rechercher tous les travaux
            listeJobs = gererPileService.rechercherTousTravaux(keyspace);

            // On met en session la liste des jobs
            session.setAttribute("listeJobs", listeJobs);
         }

         // Filtrer les travaux
         Date dateCreationMin = gererPileTravauxForm.getDateDebut();
         Date dateCreationMax = gererPileTravauxForm.getDateFin();
         String type = gererPileTravauxForm.getType();
         String state = gererPileTravauxForm.getState();
         String saeHost = gererPileTravauxForm.getSaeHost();
         String clientHost = gererPileTravauxForm.getClientHost();
         String parameters = gererPileTravauxForm.getParameters();
         List<JobRequest> listeJobsAffiches = filtrerJobs(listeJobs,
               dateCreationMin, dateCreationMax, type, state, parameters,
               saeHost, clientHost);
         request.setAttribute("listeJobAffiches", listeJobsAffiches);
      }
      
      for (String pagm : listePagm) {
         if ("ADMIN_TECHNIQUE".equals(pagm)) {
            return "gererPile";
         }
      }
      
      
      return "consulterPile";
   }

   
   
   
   
   /**
    * Filtrage des jobs en fonction des critères de recherche
    * 
    * @param listeJobs
    *           la liste des jobs à filtrer
    * @param dateCreationMin
    *           la date de création minimale des jobs
    * @param dateCreationMax
    *           la date de création maximale des jobs
    * @param type
    *           le type des jobs
    * @param state
    *           l'état des jobs
    * @param parameters
    *           les paramètres des jobs
    * @param saeHost
    *           saeHost
    * @param clientHost
    *           client Host
    * @return la liste des jobs filtrés
    */
   private List<JobRequest> filtrerJobs(List<JobRequest> listeJobs,
         Date dateCreationMin, Date dateCreationMax, String type, String state,
         String parameters, String saeHost, String clientHost) {

      List<JobRequest> listeJobsFiltres = new ArrayList<JobRequest>();

      for (JobRequest job : listeJobs) {
         boolean jobAGarder = true;

         if (dateCreationMin != null) {
            if (dateCreationMin.after(job.getCreationDate())) {
               jobAGarder = false;
            }
         }
         if (dateCreationMax != null) {
            if (dateCreationMax.before(job.getCreationDate())) {
               jobAGarder = false;
            }
         }
         if (StringUtils.isNotBlank(type)) {
            if (!type.equals(job.getType()) && !"TOUS".equals(type)) {
               jobAGarder = false;
            }
         }
         if (StringUtils.isNotBlank(state)) {
            if (!state.equals(job.getState().toString())
                  && !"TOUS".equals(state)) {
               jobAGarder = false;
            }
         }
         if (StringUtils.isNotBlank(parameters)) {
            if (!parameters.equals(job.getParameters())) {
               jobAGarder = false;
            }
         }
         if (StringUtils.isNotBlank(saeHost)) {
            if (!saeHost.equals(job.getSaeHost())) {
               jobAGarder = false;
            }
         }
         if (StringUtils.isNotBlank(clientHost)) {
            if (!clientHost.equals(job.getClientHost())) {
               jobAGarder = false;
            }
         }
         if (jobAGarder) {
            listeJobsFiltres.add(job);
         }

      }
      return listeJobsFiltres;
   }

}
