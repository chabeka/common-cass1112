package fr.urssaf.image.sae.ihm.web.exploit.controller;

import java.io.PrintWriter;
import java.io.StringWriter;
import java.text.DecimalFormat;
import java.text.NumberFormat;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.UUID;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import javax.validation.Valid;

import me.prettyprint.hector.api.Keyspace;

import org.apache.commons.collections.CollectionUtils;
import org.apache.commons.lang.StringUtils;
import org.apache.commons.lang.time.DateUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.validation.BindingResult;
import org.springframework.validation.ObjectError;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.servlet.ModelAndView;

import com.netflix.curator.framework.CuratorFramework;

import fr.urssaf.image.sae.commons.utils.Constantes;
import fr.urssaf.image.sae.commons.utils.Constantes.TYPES_JOB;
import fr.urssaf.image.sae.ihm.web.exploit.exception.AucunJobException;
import fr.urssaf.image.sae.ihm.web.exploit.exception.ErreurTechniqueException;
import fr.urssaf.image.sae.ihm.web.exploit.exception.MiseAJourJobException;
import fr.urssaf.image.sae.ihm.web.exploit.formulaire.GererPileTravauxForm;
import fr.urssaf.image.sae.ihm.web.exploit.modele.CnpCompteur;
import fr.urssaf.image.sae.ihm.web.exploit.modele.ConfigurationBean;
import fr.urssaf.image.sae.ihm.web.exploit.modele.ConfigurationEnvironnement;
import fr.urssaf.image.sae.ihm.web.exploit.modele.ConfigurationsEnvironnement;
import fr.urssaf.image.sae.ihm.web.exploit.modele.Job;
import fr.urssaf.image.sae.ihm.web.exploit.modele.ParameterModel;
import fr.urssaf.image.sae.ihm.web.exploit.service.ContratServiceService;
import fr.urssaf.image.sae.ihm.web.exploit.service.GererPileService;
import fr.urssaf.image.sae.ihm.web.exploit.service.impl.ContratServiceServiceImpl;
import fr.urssaf.image.sae.ihm.web.exploit.utils.CNPEnum;
import fr.urssaf.image.sae.pile.travaux.model.JobHistory;
import fr.urssaf.image.sae.pile.travaux.model.JobRequest;
import fr.urssaf.image.sae.pile.travaux.model.JobState;

/**
 * Classe centralisant les opérations utilsateur pour la manipulation de la pile
 * des travaux
 * 
 * 
 */
@Controller
public class GererPileTravauxController {

   /**
    * Service permettant de réaliser les opérations sur la pile des travaux
    */
   @Autowired
   private GererPileService gererPileService;

   @Autowired
   private ConfigurationsEnvironnement config;

   /**
    * Bean contenant des informations de l'application
    */
   @Autowired
   private ConfigurationBean configuration;

   // Numéro de colonne de la date de création dans le cas de la consultation ou
   // de la gestion (Sert pour le tri de la pile des travaux par date de
   // création)
   private static final int NUM_COLONNE_DATE_CREATION_CONSULT = 4;
   private static final int NUM_COLONNE_DATE_CREATION_GESTION = 6;

   // Nombre de ligne à afficher dans le tableau de résultats
   private static final int NB_LIGNE_TABLEAU = 10;

   private static final int MAX_CODE_CLIENT = 200;

   private static final int MINUIT = 24;
   private static final int HEURE_MAX = 23;
   private static final int MINUTE_MAX = 59;

   /**
    * Initialisation de l'écran de consultation/gestion de la pile des travaux
    * 
    * @param gererPileTravauxForm
    *           Formulaire de gestion de la pile
    * @param result
    *           Result
    * @param session
    *           Session
    * @param request
    *           Request
    * @return la page à afficher
    */
   @SuppressWarnings("unchecked")
   @RequestMapping(value = { "consulterPile", "gererPile" })
   public final String initialisation(
         @ModelAttribute("gererPileTravauxForm") @Valid GererPileTravauxForm gererPileTravauxForm,
         BindingResult result, HttpSession session, HttpServletRequest request) {

      try {

         // Récupération de la configuration choisie
         String nomConf = (String) session.getAttribute("nomConfiguration");
         Keyspace keyspace = (Keyspace) session.getServletContext()
               .getAttribute(nomConf);

         CuratorFramework curator = (CuratorFramework) session
               .getServletContext().getAttribute(nomConf + "-zookeeper");
         ContratServiceService csService = new ContratServiceServiceImpl(
               keyspace, config.getConfiguration(nomConf), curator);

         List<TYPES_JOB> listeTypesServices = Arrays.asList(TYPES_JOB.values());
         request.setAttribute("listeTypesServices", listeTypesServices);

         List<JobState> listeEtatJob = Arrays.asList(JobState.values());
         request.setAttribute("listeEtatJob", listeEtatJob);

         List<String> listeCodesClient = csService
               .findAllCodeClientCs(MAX_CODE_CLIENT);
         request.setAttribute("listeCodesClient", listeCodesClient);

         List<String> listeParametres = config.getConfiguration(nomConf)
               .getParametres();
         request.setAttribute("listeParametres", listeParametres);

         // Récupération des droits de l'utilisateur
         List<String> listePagm = (List<String>) session
               .getAttribute("pagmList");

         // Liste des noms des colonnes
         List<String> colonnes = new ArrayList<String>();
         colonnes.add("type");
         colonnes.add("parameters");
         colonnes.add("state");
         colonnes.add("relance");
         colonnes.add("saeHost");
         colonnes.add("clientHost");
         colonnes.add("docCount");
         colonnes.add("docCountTraite");
         colonnes.add("reservationDate");
         colonnes.add("reservedBy");
         colonnes.add("startingDate");
         colonnes.add("pid");
         colonnes.add("endingDate");
         colonnes.add("message");
         colonnes.add("toCheckFlag");
         colonnes.add("toCheckFlagRaison");
         colonnes.add("VI");
         request.setAttribute("colonnes", colonnes);

         // Mode affichage
         String modeAffichage = gererPileTravauxForm.getModeAffichage();

         // Nombre de clé maximum à récupérer lors de la récupération de la pile
         // de
         // travaux
         int maxKeysToReadConf = configuration.getMaxKeysToRead();
         request.setAttribute("maxKeysToReadConf", maxKeysToReadConf);
         int maxKeysToRead = maxKeysToReadConf;

         if (!StringUtils.isEmpty(gererPileTravauxForm.getMaxKeysToRead())) {
            maxKeysToRead = Integer.parseInt(gererPileTravauxForm
                  .getMaxKeysToRead());
         }
         if (maxKeysToRead <= 0) {
            gererPileTravauxForm.setMaxKeysToRead(null);
         } else {
            gererPileTravauxForm.setMaxKeysToRead(Integer
                  .toString(maxKeysToRead));
         }

         if (StringUtils.isBlank(modeAffichage)) {
            // Par défaut
            modeAffichage = "complet";
            gererPileTravauxForm.setModeAffichage(modeAffichage);
         }

         boolean premierAffichage = false;
         // Nombre de ligne max du tableau de résultat
         if (gererPileTravauxForm.getNbLignesTableau() == 0) {
            premierAffichage = true;
            gererPileTravauxForm.setNbLignesTableau(NB_LIGNE_TABLEAU);
            request.setAttribute("nbLignesTableau", NB_LIGNE_TABLEAU);
            gererPileTravauxForm.setHeureDebut("00");
            gererPileTravauxForm.setMinuteDebut("00");
            gererPileTravauxForm.setHeureFin("24");
            gererPileTravauxForm.setMinuteFin("00");
         } else {
            request.setAttribute("nbLignesTableau",
                  gererPileTravauxForm.getNbLignesTableau());
         }

         // Colonnes à afficher
         List<String> colonnesAffichees = new ArrayList<String>();
         if ("minimal".equals(modeAffichage)) {
            colonnesAffichees.add("type");
            colonnesAffichees.add("parameters");
            colonnesAffichees.add("state");
         } else if ("personnalise".equals(modeAffichage)) {
            List<String> colonnesChoisies = gererPileTravauxForm
                  .getColonnesAffichees();
            if (colonnesChoisies == null) {
               colonnesAffichees.add("type");
               colonnesAffichees.add("parameters");
               colonnesAffichees.add("state");

            } else {
               colonnesAffichees = colonnesChoisies;
            }
         } else if ("complet".equals(modeAffichage)) {
            colonnesAffichees = colonnes;
         }

         gererPileTravauxForm.setColonnesAffichees(colonnesAffichees);

         // Tri par défaut sur la colonne de date de création
         int numColonneDateCreation;
         if (request.getServletPath().equals("/consulterPile.do")) {
            numColonneDateCreation = NUM_COLONNE_DATE_CREATION_CONSULT;
         } else {
            numColonneDateCreation = NUM_COLONNE_DATE_CREATION_GESTION;
         }
         request.setAttribute("numColonneDateCreation", numColonneDateCreation);

         if (!premierAffichage) {
            // Si pas d'erreur dans le formulaire, on fait la recherche et/ou le
            // filtrage des jobs
            if (!result.hasFieldErrors()) {
               String action = request.getParameter("action");
               try {
                  // Suppression de job
                  if ("supprimer".equals(action)) {
                     UUID idATraiter = gererPileTravauxForm
                           .getIdentifiantATraiter();
                     gererPileService.supprimerTravail(idATraiter, keyspace);
                     gererPileTravauxForm.setIdentifiantATraiter(null);
                     gererPileService.refreshTousTravaux(keyspace,
                           maxKeysToRead);
                     session.removeAttribute("listeJobs");
                  }

                  // Affichage de l'historique du job
                  if ("historique".equals(action)) {
                     UUID idATraiter = gererPileTravauxForm
                           .getIdentifiantATraiter();
                     gererPileTravauxForm.setIdentifiantATraiter(null);
                     List<JobHistory> historique;
                     try {
                        historique = gererPileService.getHistorique(idATraiter,
                              keyspace);
                        request.setAttribute("historique", historique);
                     } catch (Exception e) {
                        String message = "Une erreur est survenue lors de la lecture de la pile des travaux";
                        ObjectError erreur = new ObjectError("rechercheForm",
                              message);
                        result.addError(erreur);

                        StringWriter sw = new StringWriter();
                        PrintWriter pw = new PrintWriter(sw);
                        e.printStackTrace(pw);
                        String stacktrace = sw.toString();
                        request.setAttribute("stacktrace", stacktrace);
                     }
                  }

               } catch (MiseAJourJobException e) {
                  ObjectError erreur = new ObjectError("rechercheForm",
                        e.getMessage());
                  result.addError(erreur);
                  StringWriter sw = new StringWriter();
                  PrintWriter pw = new PrintWriter(sw);
                  e.printStackTrace(pw);
                  String stacktrace = sw.toString();
                  request.setAttribute("stacktrace", stacktrace);
               } catch (AucunJobException e) {
                  ObjectError erreur = new ObjectError("rechercheForm",
                        "Le job n'existe pas !");
                  result.addError(erreur);
               }

               // Si on lance une recherche (et non un filtre),
               // Si la liste des jobs n'est pas déjà en session,
               // Si la liste des jobs est en session mais que le maxKeysToRead
               // a
               // été modifié,
               // et si on ne cherche pas un job précis (uuid fourni dans le
               // formulaire)
               // on récupère les jobs en base
               // Sinon on utilise ceux en session
               List<Job> listeJobs = (List<Job>) session
                     .getAttribute("listeJobs");
               UUID identifiantATraiter = gererPileTravauxForm
                     .getIdentifiantATraiter();

               int lastMaxKeysToRead = (Integer) session
                     .getAttribute("lastMaxKeysToRead");

               if ("refreshDatas".equals(action)) {
                  try {
                     listeJobs = gererPileService.refreshTousTravaux(keyspace,
                           maxKeysToRead);
                  } catch (Exception e) {
                     String message = "Une erreur est survenue lors de la lecture de la pile des travaux\n\n";
                     ObjectError erreur = new ObjectError("rechercheForm",
                           message);
                     result.addError(erreur);
                     StringWriter sw = new StringWriter();
                     PrintWriter pw = new PrintWriter(sw);
                     e.printStackTrace(pw);
                     String stacktrace = sw.toString();
                     request.setAttribute("stacktrace", stacktrace);

                  }

                  // On met en session la liste des jobs
                  session.setAttribute("listeJobs", listeJobs);

               } else if ((listeJobs == null && identifiantATraiter == null)
                     || (listeJobs != null && lastMaxKeysToRead != maxKeysToRead)) {
                  // Rechercher tous les travaux
                  try {
                     listeJobs = gererPileService.rechercherTousTravaux(
                           keyspace, maxKeysToRead);
                  } catch (Exception e) {
                     String message = "Une erreur est survenue lors de la lecture de la pile des travaux\n\n";
                     ObjectError erreur = new ObjectError("rechercheForm",
                           message);
                     result.addError(erreur);
                     StringWriter sw = new StringWriter();
                     PrintWriter pw = new PrintWriter(sw);
                     e.printStackTrace(pw);
                     String stacktrace = sw.toString();
                     request.setAttribute("stacktrace", stacktrace);

                  }

                  // On met en session la liste des jobs
                  session.setAttribute("listeJobs", listeJobs);
               }

               // Récupération des paramètres de filtrage

               Date dateCreationMinTmp = gererPileTravauxForm.getDateDebut();
               Date dateCreationMaxTmp = gererPileTravauxForm.getDateFin();
               String heureDebut = gererPileTravauxForm.getHeureDebut();
               String minuteDebut = gererPileTravauxForm.getMinuteDebut();
               String heureFin = gererPileTravauxForm.getHeureFin();
               String minuteFin = gererPileTravauxForm.getMinuteFin();
               // Ajout des heures dans les dates de début et de fin
               Date dateCreationMin = calculeDate(dateCreationMinTmp,
                     heureDebut, minuteDebut);
               Date dateCreationMax = calculeDate(dateCreationMaxTmp, heureFin,
                     minuteFin);
               String type = gererPileTravauxForm.getType();
               String state = gererPileTravauxForm.getState();
               String saeHost = gererPileTravauxForm.getSaeHost();
               String clientHost = gererPileTravauxForm.getClientHost();
               String parameters = gererPileTravauxForm.getParameters();
               if ("SAISIE".equals(parameters)) {
                  parameters = gererPileTravauxForm.getParametersSaisi();
               }
               String contratService = gererPileTravauxForm.getContratService();

               // On regarde si un filtrage est actif
               if (dateCreationMin == null
                     && dateCreationMax == null
                     && ("TOUS".equals(type) || StringUtils.isBlank(type))
                     && ("TOUS".equals(state) || StringUtils.isBlank(state))
                     && StringUtils.isBlank(saeHost)
                     && StringUtils.isBlank(clientHost)
                     && ("TOUS".equals(parameters) || StringUtils
                           .isBlank(parameters))
                           && ("TOUS".equals(contratService) || StringUtils
                                 .isBlank(contratService))
                                 && identifiantATraiter == null) {
                  if (maxKeysToRead > 0 && maxKeysToRead != maxKeysToReadConf) {
                     request.setAttribute("filtreActif", true);
                  } else {
                     request.setAttribute("filtreActif", false);
                  }

                  comptage(listeJobs, listeJobs,
                        gererPileTravauxForm.isVisuRelance(), request, type);

               } else {
                  request.setAttribute("filtreActif", true);

                  List<Job> listeJobsAffiches = new ArrayList<Job>();
                  // Si on fait une recherche par job, on le récupère
                  // directement
                  // en base, sans parcourir tous les jobs
                  // Cela évite qu'il ne soit pas trouvé si le pile des travaux
                  // remontée est incomplète (nombre d'éléments retournés
                  // limité)
                  if (identifiantATraiter != null) {
                     try {
                        listeJobsAffiches.add(gererPileService.getJob(keyspace,
                              identifiantATraiter));
                     } catch (Exception e) {
                        ObjectError erreur = new ObjectError("rechercheForm",
                              "Le job n'existe pas !");
                        result.addError(erreur);
                     }
                  } else {

                     // Filtrer les travaux
                     listeJobsAffiches = filtrerJobs(listeJobs,
                           identifiantATraiter, dateCreationMin,
                           dateCreationMax, type, state, parameters, saeHost,
                           clientHost, contratService);
                  }

                  comptage(listeJobs, listeJobsAffiches,
                        gererPileTravauxForm.isVisuRelance(), request, type);

               }
            }
         } else {
            // 1er affichage

            // Initialisation du cache de jobs
            gererPileService.intialisationCache(keyspace, maxKeysToRead,
                  configuration.getJobCacheDuration());

            // On s'assure de vider la liste des jobs de la session (lorsqu'on
            // change d'environnement par exemple ou quand on relance le menu)
            if (session.getAttribute("listeJobs") != null) {
               session.setAttribute("listeJobs", null);
            }
         }

         // On stocke le nombre de clé max
         session.setAttribute("lastMaxKeysToRead", maxKeysToRead);

         for (String pagm : listePagm) {
            if ("ADMIN_TECHNIQUE".equals(pagm)) {
               return "gererPile";
            }
         }

      } catch (Throwable ex) {

         StringWriter sw = new StringWriter();
         PrintWriter pw = new PrintWriter(sw);
         ex.printStackTrace(pw);
         String stacktrace = sw.toString();
         request.setAttribute("stacktrace", stacktrace);

      }

      return "consulterPile";
   }

   @RequestMapping(value = "consulterPileParServeur")
   public ModelAndView consulterPileParServeur(
         @ModelAttribute("gererPileTravauxForm") @Valid GererPileTravauxForm gererPileTravauxForm,
         BindingResult result, HttpServletRequest request,
         HttpServletResponse response) {

      ModelAndView model = new ModelAndView("consulterPileParServeur");

      // Récupération de la configuration choisie
      String nomConf = (String) request.getSession().getAttribute(
            "nomConfiguration");
      Keyspace keyspace = (Keyspace) request.getSession().getServletContext()
            .getAttribute(nomConf);

      String action = request.getParameter("action");
      boolean premierAffichage = false;

      ConfigurationEnvironnement conf = config.getConfiguration(nomConf);
      String urlServiceWeb = conf.getUrlWs().toString();
      // Récupération du login de l'utilisateur (pour la traçabilité)
      String login = (String) request.getSession().getAttribute("login");

      // initialisation si necessaire du nombre de ligne du tableau
      if (gererPileTravauxForm.getNbLignesTableau() == 0) {
         gererPileTravauxForm.setNbLignesTableau(NB_LIGNE_TABLEAU);
         premierAffichage = true;
      }

      try {
         if (!premierAffichage) {
            // Déblocage de job
            if ("debloquer".equals(action)) {
               UUID idATraiter = gererPileTravauxForm.getIdentifiantATraiter();
               // gererPileService.supprimerTravail(idATraiter, keyspace);
               gererPileService.debloquerJob(idATraiter.toString(),
                     urlServiceWeb, login);
               gererPileTravauxForm.setIdentifiantATraiter(null);
            }
         }
      } catch (ErreurTechniqueException e) {
         ObjectError erreur = new ObjectError("rechercheForm", e.getMessage());

         StringWriter sw = new StringWriter();
         PrintWriter pw = new PrintWriter(sw);
         e.printStackTrace(pw);
         String stacktrace = sw.toString();
         request.setAttribute("stacktrace", stacktrace);
         result.addError(erreur);
      }

      model.addObject("gererPileTravauxForm", gererPileTravauxForm);

      // ajout du nombre de lignes du tableau dans le model
      model.addObject("nbLignesTableau",
            gererPileTravauxForm.getNbLignesTableau());

      // Récupére la liste des jobs en cours par serveur
      List<JobRequest> jobsParServeur = gererPileService
            .recupererTravauxEnCoursParServeur(keyspace);
      model.addObject("listeJobsEnCours", jobsParServeur);

      return model;
   }

   private void comptage(List<Job> listeJobs, List<Job> listeJobsAffiches,
         boolean visuRelance, HttpServletRequest request, String typeJobFiltre) {
      int docCountTotal = 0;
      int nbJobEnErreur = 0;
      int nbJobErreurCNP69 = 0;
      int nbDocsNonArchiveCNP69 = 0;
      int nbJobErreurCNP31 = 0;
      int nbDocsNonArchiveCNP31 = 0;
      int nbJobErreurCNP75 = 0;
      int nbDocsNonArchiveCNP75 = 0;
      int nbJobErreurAutre = 0;
      int nbDocsNonArchiveAutre = 0;
      int nbTraitementRelance = 0;
      int nbTraitementRelanceSucces = 0;
      int nbTraitementRelanceCNP69 = 0;
      int nbTraitementRelanceSuccesCNP69 = 0;
      int nbTraitementRelanceCNP75 = 0;
      int nbTraitementRelanceSuccesCNP75 = 0;
      int nbTraitementRelanceCNP31 = 0;
      int nbTraitementRelanceSuccesCNP31 = 0;
      int nbTraitementRelanceAutre = 0;
      int nbTraitementRelanceSuccesAutre = 0;

      Map<CNPEnum, CnpCompteur> mapCompteur = new HashMap<CNPEnum, CnpCompteur>();
      mapCompteur.put(CNPEnum.CNP31, new CnpCompteur());
      mapCompteur.put(CNPEnum.CNP69, new CnpCompteur());
      mapCompteur.put(CNPEnum.CNP69f, new CnpCompteur());
      mapCompteur.put(CNPEnum.AUTRES, new CnpCompteur());
      // Gestion des totaux de documents traités et non traités


      // Comptage global de nbr de doc traités et non traités pour chaque
      // traitement de masse
      // NB. Le DocCountTraite prend en compte les docs traités pas la reprise
      if (CollectionUtils.isNotEmpty(listeJobsAffiches)) {
         for (Job job : listeJobsAffiches) {
            CnpCompteur compteur = getCompteurByCNP(job, mapCompteur);
            comptage(job, compteur);
         }
      }

      if (CollectionUtils.isNotEmpty(listeJobsAffiches)) {
         List<String> listeTraitementRelance = new ArrayList<String>();
         for (Job job : listeJobsAffiches) {
            String urlEcde = getUrlEcdeOrHost(job);
            if (job.getState() == JobState.FAILURE) {

               if (urlEcde.contains(CNPEnum.CNP31.getIndice())) {
                  nbJobErreurCNP31++;
                  if (job.getDocCount() != null) {
                     nbDocsNonArchiveCNP31 += job.getDocCount();
                  }
               } else if (urlEcde.contains(CNPEnum.CNP69.getIndice())) {
                  nbJobErreurCNP69++;
                  if (job.getDocCount() != null) {
                     nbDocsNonArchiveCNP69 += job.getDocCount();
                  }
               } else if (urlEcde.contains(CNPEnum.CNP69f.getIndice())) {
                  nbJobErreurCNP75++;
                  if (job.getDocCount() != null) {
                     nbDocsNonArchiveCNP75 += job.getDocCount();
                  }
               } else {
                  // dans ce cas, on est en environnement autre que la
                  // production
                  nbJobErreurAutre++;
                  if (job.getDocCount() != null) {
                     nbDocsNonArchiveAutre += job.getDocCount();
                  }
               }

               nbJobEnErreur++;

            }

            // On visualise les traitements relancés si l'option est activée
            if (visuRelance
                  && !TYPES_JOB.reprise_masse.name().equals(typeJobFiltre)
                  && !TYPES_JOB.reprise_masse.name().equals(job.getType())
                  && Arrays.asList(JobState.FAILURE, JobState.REPLAY_SUCCESS,
                        JobState.ABORT).contains(job.getState())) {
               Job jobReprise = getJobTraitementRelance(job, listeJobs);

               if (jobReprise != null
                     && !listeTraitementRelance.contains(jobReprise.getIdJob()
                           .toString())) {

                  // On regarde si un des traitements relancés est en succès
                  if (jobReprise.getState() == JobState.SUCCESS) {
                     job.setSuccesRelance(true);
                  }

                  if (job.isSuccesRelance()) {
                     nbTraitementRelanceSucces++;
                     if (urlEcde.contains(CNPEnum.CNP31.getIndice())) {
                        nbTraitementRelanceSuccesCNP31++;
                     } else if (urlEcde.contains(CNPEnum.CNP69.getIndice())) {
                        nbTraitementRelanceSuccesCNP69++;
                     } else if (urlEcde
.contains(CNPEnum.CNP69f.getIndice())) {
                        nbTraitementRelanceSuccesCNP75++;
                     } else {
                        nbTraitementRelanceSuccesAutre++;
                     }
                  }
                  nbTraitementRelance++;
                  if (urlEcde.contains(CNPEnum.CNP31.getIndice())) {
                     nbTraitementRelanceCNP31++;
                  } else if (urlEcde.contains(CNPEnum.CNP69.getIndice())) {
                     nbTraitementRelanceCNP69++;
                  } else if (urlEcde.contains(CNPEnum.CNP69f.getIndice())) {
                     nbTraitementRelanceCNP75++;
                  } else {
                     nbTraitementRelanceAutre++;
                  }

                  listeTraitementRelance.add(jobReprise.getIdJob().toString());
               }

            }

            if (TYPES_JOB.reprise_masse.toString().equals(typeJobFiltre)
                  || !job.getType().equals(TYPES_JOB.reprise_masse.toString())) {
               if (job.getDocCount() != null) {
                  docCountTotal += job.getDocCount();
               } else if (job.getDocCountTraite() != null) {
                  docCountTotal += job.getDocCountTraite();
               }
            }
         }
      }

      NumberFormat formatter = new DecimalFormat("##,###");

      request.setAttribute("nbJobEnErreur", formatter.format(nbJobEnErreur));
      request.setAttribute("nbTraitementRelance",
            formatter.format(nbTraitementRelance));
      request.setAttribute("nbTraitementRelanceSucces",
            formatter.format(nbTraitementRelanceSucces));

      request.setAttribute("nbJobErreurCNP31",
            formatter.format(nbJobErreurCNP31));
      request.setAttribute("nbDocsNonArchiveCNP31",
            formatter.format(nbDocsNonArchiveCNP31));
      request.setAttribute("nbTraitementRelanceCNP31",
            formatter.format(nbTraitementRelanceCNP31));
      request.setAttribute("nbTraitementRelanceSuccesCNP31",
            formatter.format(nbTraitementRelanceSuccesCNP31));

      request.setAttribute("nbJobErreurCNP69",
            formatter.format(nbJobErreurCNP69));
      request.setAttribute("nbDocsNonArchiveCNP69",
            formatter.format(nbDocsNonArchiveCNP69));
      request.setAttribute("nbTraitementRelanceCNP69",
            formatter.format(nbTraitementRelanceCNP69));
      request.setAttribute("nbTraitementRelanceSuccesCNP69",
            formatter.format(nbTraitementRelanceSuccesCNP69));

      request.setAttribute("nbJobErreurCNP75",
            formatter.format(nbJobErreurCNP75));
      request.setAttribute("nbDocsNonArchiveCNP75",
            formatter.format(nbDocsNonArchiveCNP75));
      request.setAttribute("nbTraitementRelanceCNP75",
            formatter.format(nbTraitementRelanceCNP75));
      request.setAttribute("nbTraitementRelanceSuccesCNP75",
            formatter.format(nbTraitementRelanceSuccesCNP75));

      request.setAttribute("nbJobErreurAutre",
            formatter.format(nbJobErreurAutre));
      request.setAttribute("nbDocsNonArchiveAutre",
            formatter.format(nbDocsNonArchiveAutre));
      request.setAttribute("nbTraitementRelanceAutre",
            formatter.format(nbTraitementRelanceAutre));
      request.setAttribute("nbTraitementRelanceSuccesAutre",
            formatter.format(nbTraitementRelanceSuccesAutre));

      request.setAttribute("docCountTotal", formatter.format(docCountTotal));
      
      for (Job job : listeJobsAffiches) {
        List<ParameterModel> jobParametersModel = new ArrayList<ParameterModel>();
        Map<String, String> jobParameters = job.getJobParameters();
        if(jobParameters != null){
           for (Map.Entry<String, String> entry : jobParameters.entrySet()) {
              jobParametersModel.add(new ParameterModel(entry.getKey(), entry.getValue()));
           }
           job.setJobParametersModel(jobParametersModel);
        }
      }
      
      request.setAttribute("listeJobAffiches", listeJobsAffiches);

      int nbDocArchivesTotal = 0;
      int nbDocModifiesTotal = 0;
      int nbDocTransferesTotal = 0;
      int nbDocSupprimesTotal = 0;
      int nbDocRestauresTotal = 0;
      int nbDocsNonArchiveTotal = 0;
      int nbDocNonModifiesTotal = 0;
      int nbDocNonTransferesTotal = 0;


      for (CNPEnum cnp : CNPEnum.values()) {
         CnpCompteur cmpt = mapCompteur.get(cnp);
         alimentationRequestAttributeByCNP(request, cmpt, cnp, formatter);

         // Calcul des totaux par type de traitement
         nbDocArchivesTotal += cmpt.getNbDocArchives();
         nbDocModifiesTotal += cmpt.getNbDocModifies();
         nbDocTransferesTotal += cmpt.getNbDocTransferes();
         nbDocSupprimesTotal += cmpt.getNbDocSupprimes();
         nbDocRestauresTotal += cmpt.getNbDocRestaures();
         nbDocsNonArchiveTotal += cmpt.getNbDocsNonArchives();
         nbDocNonModifiesTotal += cmpt.getNbDocNonModifies();
         nbDocNonTransferesTotal += cmpt.getNbDocNonTransferes();
      }

      // Gestion des totaux par type de traitement
      request.setAttribute("nbDocArchivesTotal",
            formatter.format(nbDocArchivesTotal));
      request.setAttribute("nbDocModifiesTotal",
            formatter.format(nbDocModifiesTotal));
      request.setAttribute("nbDocTransferesTotal",
            formatter.format(nbDocTransferesTotal));
      request.setAttribute("nbDocSupprimesTotal",
            formatter.format(nbDocSupprimesTotal));
      request.setAttribute("nbDocRestauresTotal",
            formatter.format(nbDocRestauresTotal));
      request.setAttribute("nbDocNonArchivesTotal",
            formatter.format(nbDocsNonArchiveTotal));
      request.setAttribute("nbDocNonModifiesTotal",
            formatter.format(nbDocNonModifiesTotal));
      request.setAttribute("nbDocNonTransferesTotal",
            formatter.format(nbDocNonTransferesTotal));
      request.setAttribute("nbDocNonSupprimesTotal", "N/A");
      request.setAttribute("nbDocNonRestauresTotal", "N/A");

   }

   /**
    * Methode permettant de
    * 
    * @param request
    * @param mapCompteur
    * @param cnp
    * @param formatter
    */
   private void alimentationRequestAttributeByCNP(HttpServletRequest request,
         CnpCompteur cmpt, CNPEnum cnp,
         NumberFormat formatter) {
      request.setAttribute("nbDocArchives" + cnp.name(),
            formatter.format(cmpt.getNbDocArchives()));
      request.setAttribute("nbDocModifies" + cnp.name(),
            formatter.format(cmpt.getNbDocModifies()));
      request.setAttribute("nbDocTransferes" + cnp.name(),
            formatter.format(cmpt.getNbDocTransferes()));
      request.setAttribute("nbDocSupprimes" + cnp.name(),
            formatter.format(cmpt.getNbDocSupprimes()));
      request.setAttribute("nbDocRestaures" + cnp.name(),
            formatter.format(cmpt.getNbDocRestaures()));
      request.setAttribute("nbDocNonArchives" + cnp.name(),
            formatter.format(cmpt.getNbDocsNonArchives()));
      request.setAttribute("nbDocNonModifies" + cnp.name(),
            formatter.format(cmpt.getNbDocNonModifies()));
      request.setAttribute("nbDocNonTransferes" + cnp.name(),
            formatter.format(cmpt.getNbDocNonTransferes()));
      request.setAttribute("nbDocNonSupprimes" + cnp.name(), "NA");
      request.setAttribute("nbDocNonRestaures" + cnp.name(), "NA");
   }

   /**
    * Methode permettant de
    * 
    * @param job
    * @param mapCompteur
    */
   private void comptage(Job job, CnpCompteur compteur) {
      if (job.getState().equals(JobState.FAILURE)
            || job.getState().equals(JobState.ABORT)
            || job.getState().equals(JobState.SUCCESS)
            || job.getState().equals(JobState.REPLAY_SUCCESS)) {
         if (job.getType().equals(TYPES_JOB.capture_masse.toString())) {
            if (job.getState().equals(JobState.SUCCESS)
                  || job.getState().equals(JobState.REPLAY_SUCCESS)) {
               if (job.getDocCountTraite() != null) {
                  compteur.setNbDocArchives(compteur.getNbDocArchives()
                        + job.getDocCountTraite());
               } else if (job.getDocCount() != null) {
                  compteur.setNbDocArchives(compteur.getNbDocArchives()
                        + job.getDocCount());
               }
            } else if (job.getDocCountTraite() != null
                  && job.getDocCount() != null) {
               compteur.setNbDocArchives(compteur.getNbDocArchives()
                     + job.getDocCountTraite());
               compteur.setNbDocsNonArchives(compteur.getNbDocsNonArchives()
                     + (job.getDocCount() - job.getDocCountTraite()));
            }
         } else if (job.getType().equals(
               TYPES_JOB.modification_masse.toString())) {
            if (job.getState().equals(JobState.SUCCESS)
                  || job.getState().equals(JobState.REPLAY_SUCCESS)) {
               if (job.getDocCountTraite() != null) {
                  compteur.setNbDocModifies(compteur.getNbDocModifies()
                        + job.getDocCountTraite());
               } else if (job.getDocCount() != null) {
                  compteur.setNbDocModifies(compteur.getNbDocModifies()
                        + job.getDocCount());
               }
            } else if (job.getDocCountTraite() != null
                  && job.getDocCount() != null) {
               compteur.setNbDocModifies(compteur.getNbDocModifies()
                     + job.getDocCountTraite());
               compteur.setNbDocNonModifies(compteur.getNbDocNonModifies()
                     + (job.getDocCount() - job.getDocCountTraite()));
            }
         } else if (job.getType().equals(TYPES_JOB.transfert_masse.toString())) {
            if ((job.getState().equals(JobState.SUCCESS) || job.getState()
                  .equals(JobState.REPLAY_SUCCESS))) {
               if (job.getDocCountTraite() != null) {
                  compteur.setNbDocTransferes(compteur.getNbDocTransferes()
                        + job.getDocCountTraite());
               } else if (job.getDocCount() != null) {
                  compteur.setNbDocTransferes(compteur.getNbDocTransferes()
                        + job.getDocCount());
               }
            } else if (job.getDocCountTraite() != null
                  && job.getDocCount() != null) {
               compteur.setNbDocTransferes(compteur.getNbDocTransferes()
                     + job.getDocCountTraite());
               compteur.setNbDocNonTransferes(compteur.getNbDocNonTransferes()
                     + (job.getDocCount() - job.getDocCountTraite()));
            }
         }
         // Comptage spécifique pour la suppression et restauration de masse en
         // cas de succès
         else if (job.getType().equals(TYPES_JOB.suppression_masse.toString())) {
            if (job.getState().equals(JobState.SUCCESS)
                  || job.getState().equals(JobState.REPLAY_SUCCESS)) {
               if (job.getDocCountTraite() != null) {
                  compteur.setNbDocSupprimes(compteur.getNbDocSupprimes()
                        + job.getDocCountTraite());
               } else if (job.getDocCount() != null) {
                  compteur.setNbDocSupprimes(compteur.getNbDocSupprimes()
                        + job.getDocCount());
               }
            }
         } else if (job.getType().equals(TYPES_JOB.restore_masse.toString())) {
            if (job.getState().equals(JobState.SUCCESS)
                  || job.getState().equals(JobState.REPLAY_SUCCESS)) {
               if (job.getDocCountTraite() != null) {
                  compteur.setNbDocRestaures(compteur.getNbDocRestaures()
                        + job.getDocCountTraite());
               } else if (job.getDocCount() != null) {
                  compteur.setNbDocRestaures(compteur.getNbDocRestaures()
                        + job.getDocCount());
               }
            }
         }
      }


   }

   /**
    * Methode permettant de
    * 
    * @param job
    * @param mapCompteur
    * @return
    */
   private CnpCompteur getCompteurByCNP(Job job,
         Map<CNPEnum, CnpCompteur> mapCompteur) {
      CnpCompteur compteur;
      String urlEcde = getUrlEcdeOrHost(job);
      if (urlEcde.contains(CNPEnum.CNP31.getIndice())) {
         compteur = mapCompteur.get(CNPEnum.CNP31);
      } else if (urlEcde.contains(CNPEnum.CNP69.getIndice())) {
         compteur = mapCompteur.get(CNPEnum.CNP69);
      } else if (urlEcde.contains(CNPEnum.CNP69f.getIndice())) {
         compteur = mapCompteur.get(CNPEnum.CNP69f);
      } else {
         compteur = mapCompteur.get(CNPEnum.AUTRES);
      }
      return compteur;
   }

   private String getUrlEcdeOrHost(Job job) {
      String urlEcde = "";
      if (job.getJobParameters() != null
            && job.getJobParameters().get("ecdeUrl") != null) {
         urlEcde = job.getJobParameters().get("ecdeUrl");
      } else if (job.getParameters() != null) {
         urlEcde = job.getParameters();
      }
      if (urlEcde.isEmpty()) {
         urlEcde = job.getSaeHost();
      }
      return urlEcde;
   }

   private Job getJobTraitementRelance(Job job, List<Job> listeJobs) {
      if (job.getType() != null
            && !TYPES_JOB.reprise_masse.name().equals(job.getType())) {
         for (Job jobReprise : listeJobs) {
            if (jobReprise.getType() != null
                  && TYPES_JOB.reprise_masse.name()
                  .equals(jobReprise.getType())) {
               String idJobRepris = null;
               if (jobReprise.getJobParameters() != null) {
                  idJobRepris = jobReprise.getJobParameters().get(
                        Constantes.ID_TRAITEMENT_A_REPRENDRE);
               }

               if (idJobRepris != null
                     && idJobRepris.equals(job.getIdJob().toString())) {
                  return jobReprise;
               }
            }
         }

      }

      return null;
   }

   @SuppressWarnings("PMD.ShortVariable")
   private Date calculeDate(Date dateDebut, String heure, String minute) {
      if (dateDebut == null) {
         return null;
      }
      Date dateOk = dateDebut;

      int hh = Integer.parseInt(heure);
      int mm = Integer.parseInt(minute);

      if (hh == MINUIT) {
         hh = HEURE_MAX;
         mm = MINUTE_MAX;
      }
      dateOk = DateUtils.setHours(dateOk, hh);
      dateOk = DateUtils.setMinutes(dateOk, mm);
      dateOk = DateUtils.setSeconds(dateOk, 0);
      dateOk = DateUtils.setMilliseconds(dateOk, 0);

      return dateOk;

   }

   /**
    * Filtrage des jobs en fonction des critères de recherche
    * 
    * @param listeJobs
    *           la liste des jobs à filtrer
    * @param dateCreationMin
    *           la date de création minimale des jobs
    * @param dateCreationMax
    *           la date de création maximale des jobs
    * @param type
    *           le type des jobs
    * @param state
    *           l'état des jobs
    * @param parameters
    *           les paramètres des jobs
    * @param saeHost
    *           saeHost
    * @param clientHost
    *           client Host
    * @return la liste des jobs filtrés
    */
   @SuppressWarnings("PMD.CollapsibleIfStatements")
   private List<Job> filtrerJobs(List<Job> listeJobs, UUID identifiantATraite,
         Date dateCreationMin, Date dateCreationMax, String type, String state,
         String parameters, String saeHost, String clientHost,
         String contratService) {

      List<Job> listeJobsFiltres = new ArrayList<Job>();

      for (Job job : listeJobs) {
         boolean jobAGarder = true;

         if (dateCreationMin != null) {
            if (dateCreationMin.after(job.getCreationDate())) {
               jobAGarder = false;
               continue;
            }
         }

         if (dateCreationMax != null) {
            if (dateCreationMax.before(job.getCreationDate())) {
               jobAGarder = false;
               continue;
            }
         }
         if (StringUtils.isNotBlank(type)) {
            if (!type.equals(job.getType()) && !"TOUS".equals(type)) {
               jobAGarder = false;
               continue;
            }
         }
         if (StringUtils.isNotBlank(state)) {
            if (!state.equals(job.getState().toString())
                  && !"TOUS".equals(state)) {
               jobAGarder = false;
               continue;
            }
         }
         if (StringUtils.isNotBlank(parameters)) {
            if (!"TOUS".equals(parameters)) {
               if (job.getJobParameters() == null) {
                  jobAGarder = false;
                  if (job.getParameters() == null
                        || !job.getParameters().contains(parameters)) {
                     jobAGarder = false;
                     continue;
                  } else {
                     jobAGarder = true;
                  }
               } else {
                  jobAGarder = false;
                  Map<String, String> mapParameters = job.getJobParameters();
                  for (String key : mapParameters.keySet()) {
                     if (mapParameters.get(key).contains(parameters)) {
                        jobAGarder = true;
                        listeJobsFiltres.add(job);
                        break;
                     }
                  }
                  continue;
               }
            }
         }
         if (StringUtils.isNotBlank(contratService) && job.getVi() != null
               && StringUtils.isNotBlank(job.getVi().getCodeAppli())) {
            if (!job.getVi().getCodeAppli().contains(contratService)
                  && !"TOUS".equals(contratService)) {
               jobAGarder = false;
               continue;
            }
         }
         if (StringUtils.isNotBlank(saeHost)) {
            if (!job.getSaeHost().contains(saeHost)) {
               jobAGarder = false;
               continue;
            }
         }
         if (StringUtils.isNotBlank(clientHost)) {
            if (!job.getClientHost().contains(clientHost)) {
               jobAGarder = false;
               continue;
            }
         }
         if (jobAGarder) {
            listeJobsFiltres.add(job);
         }
      }

      return listeJobsFiltres;
   }

}
