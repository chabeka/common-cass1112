package fr.urssaf.image.sae.ihm.web.exploit.service.impl;

import java.util.List;

import org.apache.commons.collections.ListUtils;

import fr.urssaf.image.commons.cassandra.helper.CassandraCQLClientFactory;
import fr.urssaf.image.commons.cassandra.support.clock.JobClockConfiguration;
import fr.urssaf.image.commons.cassandra.support.clock.JobClockSupport;
import fr.urssaf.image.commons.cassandra.support.clock.impl.JobClockSupportImpl;
import fr.urssaf.image.sae.ihm.web.exploit.service.DictionaryService;
import fr.urssaf.image.sae.metadata.exceptions.DictionaryNotFoundException;
import fr.urssaf.image.sae.metadata.referential.dao.DictionaryDao;
import fr.urssaf.image.sae.metadata.referential.dao.cql.IDictionaryDaoCql;
import fr.urssaf.image.sae.metadata.referential.dao.cql.impl.DictionaryCqlDaoImpl;
import fr.urssaf.image.sae.metadata.referential.model.Dictionary;
import fr.urssaf.image.sae.metadata.referential.support.DictionarySupport;
import fr.urssaf.image.sae.metadata.referential.support.cql.DictionaryCqlSupport;
import fr.urssaf.image.sae.metadata.referential.support.facade.DictionarySupportFacade;
import me.prettyprint.hector.api.Keyspace;

/**
 * Classe implémentant le service DictionaryService
 * 
 * 
 */
public class DictionaryServiceImpl implements DictionaryService {

  private DictionarySupport dictSupport;

  private DictionaryCqlSupport dictCqlSupport;

  private DictionarySupportFacade dictSupportFacade;

  private JobClockSupport jobClock;



  /**
   * Methode permettant de récupérer tous les dictionnaires présents dans la
   * base Cassandra
   * 
   * @param keyspace
   *           keyspace à intérroger
   * @return List<Dictionary> liste de dictionnaires
   */
  @Override
  public final List<Dictionary> findAllDictionaries(final Keyspace keyspace, final CassandraCQLClientFactory ccf) {
    setClockSupport(keyspace);
    setFacade(keyspace, ccf);
    return dictSupportFacade.findAll();
  }


  /**
   * Methode permettant de récupérer un dictionnaire présent dans la base
   * Cassandra
   * 
   * @param keyspace
   *           keyspace à intérroger
   * @param dict identifiant du dictionnaire à trouver          
   * @return Dictionary un dictionnaire
   */
  @Override
  public final Dictionary findDictionary(final String dict,
                                         final Keyspace keyspace, final CassandraCQLClientFactory ccf) {

    setClockSupport(keyspace);
    setFacade(keyspace, ccf);

    return dictSupportFacade.find(dict);
  }

  /**
   * Methode permettant de créer ou modifier un dictionnaire dans la base cassandra
   * 
   * @param dict
   *           un dictionnaire
   * @param clock
   *           JobClockConfiguration
   * @param keyspace
   *           keyspace à intérroger
   * 
   */
  @Override
  public final void createOrModifyDictionary(final Dictionary dict,
                                             final JobClockConfiguration clock, final Keyspace keyspace, final CassandraCQLClientFactory ccf) {
    setClockSupport(keyspace);
    setFacade(keyspace, ccf);

    try{

      final Dictionary dictExist = dictSupportFacade.find(dict.getIdentifiant());
      // modification d'un dictionnaire on peut ajouter ou supprimer des valeurs
      final List<String> elementAjout = ListUtils.subtract(dict.getEntries(), dictExist.getEntries());
      final List<String> elementSup = ListUtils.subtract(dictExist.getEntries(), dict.getEntries());
      //suppression des éléments
      for(final String sup : elementSup){
        if(!dict.getEntries().contains(sup)){
          dictSupportFacade.deleteElement(dict.getIdentifiant(), sup);
        }
      }
      // Ajout des élements
      for(final String ajout : elementAjout){
        if(!dictExist.getEntries().contains(ajout)){
          dictSupportFacade.addElement(dict.getIdentifiant(), ajout);
        }
      }

    }catch(final DictionaryNotFoundException ex){
      // ajout d'un nouveau dictionnaire
      for(final String value : dict.getEntries()){         
        dictSupportFacade.addElement(dict.getIdentifiant(), value);
      }
    }
  }

  /**
   * @param keyspace
   * @param ccf
   */
  private void setFacade(final Keyspace keyspace, final CassandraCQLClientFactory ccf) {
    // Support thrift
    dictSupport = new DictionarySupport(new DictionaryDao(keyspace));
    // Support Cql
    final IDictionaryDaoCql dictionaryDaoCql = new DictionaryCqlDaoImpl(ccf);
    dictCqlSupport = new DictionaryCqlSupport(dictionaryDaoCql);
    // Facade
    dictSupportFacade = new DictionarySupportFacade(dictSupport, dictCqlSupport, jobClock);
  }

  /**
   * @param keyspace
   */
  private void setClockSupport(final Keyspace keyspace) {
    final JobClockConfiguration clock = new JobClockConfiguration();
    clock.setMaxTimeSynchroError(10000000);
    clock.setMaxTimeSynchroWarn(2000000);

    jobClock = new JobClockSupportImpl(keyspace, clock);
  }

}
