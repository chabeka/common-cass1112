package fr.urssaf.image.sae.ihm.web.exploit.service.impl;

import java.util.List;

import org.apache.commons.collections.ListUtils;

import fr.urssaf.image.commons.cassandra.helper.CassandraCQLClientFactory;
import fr.urssaf.image.commons.cassandra.support.clock.JobClockConfiguration;
import fr.urssaf.image.commons.cassandra.support.clock.JobClockSupport;
import fr.urssaf.image.commons.cassandra.support.clock.impl.JobClockSupportImpl;
import fr.urssaf.image.sae.ihm.web.exploit.service.DictionaryService;
import fr.urssaf.image.sae.metadata.exceptions.DictionaryNotFoundException;
import fr.urssaf.image.sae.metadata.referential.dao.DictionaryDao;
import fr.urssaf.image.sae.metadata.referential.model.Dictionary;
import fr.urssaf.image.sae.metadata.referential.support.DictionarySupport;
import fr.urssaf.image.sae.metadata.referential.support.cql.DictionaryCqlSupport;
import me.prettyprint.hector.api.Keyspace;

/**
 * Classe implémentant le service DictionaryService
 * 
 * 
 */
public class DictionaryServiceImpl implements DictionaryService {

  private DictionarySupport dictSupport;

  private DictionaryCqlSupport dictCqlSupport;

  private JobClockSupport jobClock;


  /**
   * Methode permettant de récupérer tous les dictionnaires présents dans la
   * base Cassandra
   * 
   * @param keyspace
   *           keyspace à intérroger
   * @return List<Dictionary> liste de dictionnaires
   */
  @Override
  public final List<Dictionary> findAllDictionaries(final Keyspace keyspace, final CassandraCQLClientFactory ccf) {
    dictSupport = new DictionarySupport(new DictionaryDao(keyspace));
    return dictSupport.findAll();
  }

  /**
   * Methode permettant de récupérer un dictionnaire présent dans la base
   * Cassandra
   * 
   * @param keyspace
   *           keyspace à intérroger
   * @param dict identifiant du dictionnaire à trouver          
   * @return Dictionary un dictionnaire
   */
  @Override
  public final Dictionary findDictionary(final String dict,
                                         final Keyspace keyspace, final CassandraCQLClientFactory ccf) {
    dictSupport = new DictionarySupport(new DictionaryDao(keyspace));
    return dictSupport.find(dict);
  }

  /**
   * Methode permettant de créer ou modifier un dictionnaire dans la base cassandra
   * 
   * @param dict
   *           un dictionnaire
   * @param clock
   *           JobClockConfiguration
   * @param keyspace
   *           keyspace à intérroger
   * 
   */
  @Override
  public final void createOrModifyDictionary(final Dictionary dict,
                                             final JobClockConfiguration clock, final Keyspace keyspace, final CassandraCQLClientFactory ccf) {
    dictSupport = new DictionarySupport(new DictionaryDao(keyspace));
    jobClock = new JobClockSupportImpl(keyspace, clock);

    try{

      final Dictionary dictExist = dictSupport.find(dict.getIdentifiant());
      // modification d'un dictionnaire on peut ajouter ou supprimer des valeurs
      final List<String> elementAjout = ListUtils.subtract(dict.getEntries(), dictExist.getEntries());
      final List<String> elementSup = ListUtils.subtract(dictExist.getEntries(), dict.getEntries());
      //suppression des éléments
      for(final String sup : elementSup){
        if(!dict.getEntries().contains(sup)){
          dictSupport.deleteElement(dict.getIdentifiant(), sup, jobClock.currentCLock());
        }
      }
      // Ajout des élements
      for(final String ajout : elementAjout){
        if(!dictExist.getEntries().contains(ajout)){
          dictSupport.addElement(dict.getIdentifiant(), ajout, jobClock.currentCLock());
        }
      }

    }catch(final DictionaryNotFoundException ex){
      // ajout d'un nouveau dictionnaire
      for(final String value : dict.getEntries()){         
        dictSupport.addElement(dict.getIdentifiant(), value, jobClock.currentCLock());
      }
    }


  }

}
