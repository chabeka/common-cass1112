package fr.urssaf.image.sae.ihm.web.exploit.service.impl;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.util.List;

import me.prettyprint.hector.api.Keyspace;

import com.thoughtworks.xstream.XStream;
import com.thoughtworks.xstream.io.xml.StaxDriver;

import fr.urssaf.image.commons.cassandra.support.clock.JobClockConfiguration;
import fr.urssaf.image.commons.cassandra.support.clock.JobClockSupport;
import fr.urssaf.image.commons.cassandra.support.clock.impl.JobClockSupportImpl;
import fr.urssaf.image.sae.ihm.web.exploit.modele.Metadonnee;
import fr.urssaf.image.sae.ihm.web.exploit.modele.Metadonnees;
import fr.urssaf.image.sae.ihm.web.exploit.service.MetadonneesService;
import fr.urssaf.image.sae.metadata.referential.dao.SaeMetadataDao;
import fr.urssaf.image.sae.metadata.referential.model.MetadataReference;
import fr.urssaf.image.sae.metadata.referential.support.SaeMetadataSupport;

/**
 * Classe implémentant le service MetadonneesService
 * 
 * 
 */
public class MetadonneesServiceImpl implements MetadonneesService {

   private SaeMetadataSupport metaSupport;

   private JobClockSupport jobClock;

   @Override
   public final Metadonnees chargerMetadonnees(File fichier)
         throws FileNotFoundException {

      // Désérialisation des objets EcdeSource via Xstream
      StaxDriver staxDriver = new StaxDriver();
      XStream xstream = new XStream(staxDriver);

      xstream.alias("metadonnee", Metadonnee.class);
      xstream.alias("metadonnees", new Metadonnee[] {}.getClass());
      Metadonnees meta = new Metadonnees();
      meta.setMetadonnees((Metadonnee[]) xstream.fromXML(new FileInputStream(
            fichier)));

      return meta;

   }

   /**
    * Methode permettant de récupérer toutes les métadonnées présentes dans la
    * base Cassandra
    * 
    * @param keyspace
    *           keyspace à intérroger
    * @return List<MetadataReference> liste de métadonnées
    */
   @Override
   public final List<MetadataReference> findAllMetadata(Keyspace keyspace) {
      metaSupport = new SaeMetadataSupport(new SaeMetadataDao(keyspace));
      return metaSupport.findAll();
   }

   /**
    * Methode permettant de récupérer une métadonnée présente dans la base
    * Cassandra
    * 
    * @param keyspace
    *           keyspace à intérroger
    * @param codeLong code long de la métadonnée à trouver          
    * @return MetadataReference une métadonnée
    */
   @Override
   public final MetadataReference findMetadata(String codeLong,
         Keyspace keyspace) {
      metaSupport = new SaeMetadataSupport(new SaeMetadataDao(keyspace));
      return metaSupport.find(codeLong);
   }

   /**
    * Methode permettant de créer ou modifier une métadonnée présente dans la
    * base Cassandra
    * 
    * @param meta
    *           une métadonnée
    * @param clock
    *           JobClockConfiguration
    * @param keyspace
    *           keyspace à intérroger
    * 
    */
   @Override
   public final void createOrModifyMetadata(MetadataReference meta,
         JobClockConfiguration clock, Keyspace keyspace) {
      metaSupport = new SaeMetadataSupport(new SaeMetadataDao(keyspace));
      jobClock = new JobClockSupportImpl(keyspace, clock);
      metaSupport.create(meta, jobClock.currentCLock());
   }

}
