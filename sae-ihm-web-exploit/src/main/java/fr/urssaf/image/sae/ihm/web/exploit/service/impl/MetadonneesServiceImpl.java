package fr.urssaf.image.sae.ihm.web.exploit.service.impl;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.util.List;

import javax.servlet.http.HttpSession;

import me.prettyprint.hector.api.Keyspace;

import com.netflix.curator.framework.CuratorFramework;
import com.netflix.curator.framework.CuratorFrameworkFactory;
import com.netflix.curator.framework.CuratorFrameworkFactory.Builder;
import com.netflix.curator.retry.ExponentialBackoffRetry;
import com.thoughtworks.xstream.XStream;
import com.thoughtworks.xstream.io.xml.StaxDriver;

import fr.urssaf.image.commons.cassandra.support.clock.JobClockConfiguration;
import fr.urssaf.image.commons.cassandra.support.clock.JobClockSupport;
import fr.urssaf.image.commons.cassandra.support.clock.impl.JobClockSupportImpl;
import fr.urssaf.image.commons.dfce.model.DFCEConnection;
import fr.urssaf.image.commons.dfce.service.DFCEConnectionService;
import fr.urssaf.image.commons.dfce.service.impl.DFCEConnectionServiceImpl;
import fr.urssaf.image.sae.ihm.web.exploit.modele.ConfigurationEnvironnement;
import fr.urssaf.image.sae.ihm.web.exploit.modele.ConfigurationsEnvironnement;
import fr.urssaf.image.sae.ihm.web.exploit.modele.Metadonnee;
import fr.urssaf.image.sae.ihm.web.exploit.modele.Metadonnees;
import fr.urssaf.image.sae.ihm.web.exploit.service.MetadonneesService;
import fr.urssaf.image.sae.metadata.dfce.ServiceProviderSupportMetadata;
import fr.urssaf.image.sae.metadata.exceptions.MetadataReferenceNotFoundException;
import fr.urssaf.image.sae.metadata.referential.dao.SaeMetadataDao;
import fr.urssaf.image.sae.metadata.referential.model.DfceConfig;
import fr.urssaf.image.sae.metadata.referential.model.MetadataReference;
import fr.urssaf.image.sae.metadata.referential.services.SaeMetaDataService;
import fr.urssaf.image.sae.metadata.referential.services.impl.SaeMetaDataServiceImpl;
import fr.urssaf.image.sae.metadata.referential.support.SaeMetadataSupport;

/**
 * Classe implémentant le service MetadonneesService
 */
public class MetadonneesServiceImpl implements MetadonneesService {

   private SaeMetaDataService metaService;

   /**
    * {@inheritDoc}
    */
   @Override
   public final Metadonnees chargerMetadonnees(File fichier)
         throws FileNotFoundException {

      // Désérialisation des objets EcdeSource via Xstream
      StaxDriver staxDriver = new StaxDriver();
      XStream xstream = new XStream(staxDriver);

      xstream.alias("metadonnee", Metadonnee.class);
      xstream.alias("metadonnees", new Metadonnee[] {}.getClass());
      Metadonnees meta = new Metadonnees();
      meta.setMetadonnees((Metadonnee[]) xstream.fromXML(new FileInputStream(
            fichier)));

      return meta;

   }

   public MetadonneesServiceImpl() {

   }

   public MetadonneesServiceImpl(HttpSession session,
         ConfigurationsEnvironnement lesConfigs) {

      // On va instantier manuellement le SaeMetaDataService des services SAE
      // (manuellement par opposition avec une instantiation par Spring)
      // Il faut utiliser les paramètres de configuration de la session en cours

      // Récupère les informations de la session courante

      String nomConf = (String) session.getAttribute("nomConfiguration");
      ConfigurationEnvironnement config = lesConfigs.getConfiguration(nomConf);

      Keyspace keyspace = (Keyspace) session.getServletContext().getAttribute(
            nomConf);

      DFCEConnection dfceConnection = (DFCEConnection) session
            .getServletContext().getAttribute(nomConf + "-dfce");

      String nomBaseDfce = (String) session.getServletContext().getAttribute(
            nomConf + "-base");

      // Instantiation du JobClockSupport
      JobClockConfiguration clock = new JobClockConfiguration();
      clock.setMaxTimeSynchroError(10000000);
      clock.setMaxTimeSynchroWarn(2000000);
      JobClockSupport jobClockSupport = new JobClockSupportImpl(keyspace, clock);

      // Connexion à Zookeeper
      CuratorFramework curator;
      try {
         Builder builder = CuratorFrameworkFactory.builder();
         builder.connectString(config.getZookeeperHost()).namespace(
               config.getZookeeperNameSpace());
         builder.retryPolicy(new ExponentialBackoffRetry(100, 10));
         curator = builder.build();
         curator.start();
      } catch (IOException e) {
         throw new IllegalStateException(e);
      }

      // Instantiation du SaeMetadataDao
      SaeMetadataDao metaDao = new SaeMetadataDao(keyspace);

      // Instantiation du SaeMetadataSupport
      SaeMetadataSupport metaSupport = new SaeMetadataSupport(metaDao);

      // Instantiation du ServiceProviderSupportMetadata
      DFCEConnectionService dfceConnectionService = new DFCEConnectionServiceImpl(
            dfceConnection);
      ServiceProviderSupportMetadata providerSupport = new ServiceProviderSupportMetadata(
            dfceConnectionService);
      providerSupport.connect();

      // Instantiation du DfceConfig
      DfceConfig dfceConfig = new DfceConfig();
      dfceConfig.setUrlToolkit(dfceConnection.getServerUrl().toString());
      dfceConfig.setLogin(dfceConnection.getLogin());
      dfceConfig.setPassword(dfceConnection.getPassword());
      dfceConfig.setBasename(nomBaseDfce);

      // Enfin, instantiation du SaeMetaDataService
      metaService = new SaeMetaDataServiceImpl(metaSupport, jobClockSupport,
            curator, providerSupport, dfceConfig);

   }

   /**
    * Methode permettant de récupérer toutes les métadonnées présentes dans la
    * base Cassandra
    * 
    * @param keyspace
    *           keyspace à intérroger
    * @return List<MetadataReference> liste de métadonnées
    */
   @Override
   public final List<MetadataReference> findAllMetadata() {
      return metaService.findAll();
   }

   /**
    * Methode permettant de récupérer une métadonnée présente dans la base
    * Cassandra
    * 
    * @param keyspace
    *           keyspace à intérroger
    * @param codeLong
    *           code long de la métadonnée à trouver
    * @return MetadataReference une métadonnée
    */
   @Override
   public final MetadataReference findMetadata(String codeLong) {
      return metaService.find(codeLong);
   }

   /**
    * Methode permettant de créer une métadonnée présente dans la
    * base Cassandra
    * 
    * @param meta
    *           une métadonnée
    */
   @Override
   public final void createMetadata(MetadataReference meta) {
      metaService.create(meta);
   }

   
   /**
    * Methode permettant de modifier une métadonnée présente dans la
    * base Cassandra
    * 
    * @param meta
    *           une métadonnée
    * @throws MetadataReferenceNotFoundException 
    */
   @Override
   public final void modifyMetadata(MetadataReference meta) throws MetadataReferenceNotFoundException {
      metaService.modify(meta);
   } 
}
