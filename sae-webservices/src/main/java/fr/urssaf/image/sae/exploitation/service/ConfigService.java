package fr.urssaf.image.sae.exploitation.service;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.util.Properties;

import javax.naming.InitialContext;
import javax.naming.NamingException;

import fr.urssaf.image.sae.exploitation.exception.ExploitationRuntimeException;




/**
 * Classe de manipulation du fichier de configuration générale.
 * 
 *
 */
public final class ConfigService {


   /**
    * Cette classe ne doit pas avoir de constructeur
    */
   private ConfigService() {
      assert false;
   }
   
   
   /**
    * Recupération contenue variable JNDI nommée <b>SAE_FICHIER_CONFIGURATION</b><br> dans le context.xml
    * Cette variable pointe vers le chemin complet du fichier de <br>configuration générale du SAE
    * @return fichier de configuration générale
    */
   public static File getFileConfig() {
            
      // Lecture de la variable JNDI contenant le chemin complet
      // du fichier de configuration générale
      String nomVarJndi = "java:comp/env/SAE_Fichier_Configuration";
      String cheminFile;
      try {
         cheminFile = (String) new InitialContext().lookup(nomVarJndi);
      } catch (NamingException e) {
         // Cette exception ne devrait jamais être levée
         // Il s'agit d'un cas technique
         throw new ExploitationRuntimeException(e);
      }
      
      // Renvoie de l'objet File correpondant
      return new File(cheminFile);
      
   }
   
   
   /**
    * Recupération du fichier de configuration DFCE
    * @return fileInputStream 
    *                      fichier de conf DFCE
    * @throws IOException
    *                      exception
    */
   public static File getCheminFichierConfigDfce() throws IOException {
      
      Properties props = getPropFileGeneral();
      
      // Lecture dans le fichier Properties de la clé contenant
      // le chemin complet du fichier de configuration DFCE
      String cheminFicConfDfce = props.getProperty("sae.dfce.cheminFichierConfig"); 
      
      // Renvoie l'objet File correspondant
      return new File(cheminFicConfDfce);
      
   }
   
   
   
   /**
    * Recupération du numéro de port JMX à partir du fichier de conf générale
    * @return int 
    *             numéro de port JMX
    * @throws IOException
    *                      exception
    */
   public static int getPortJMX() throws IOException {
      
      Properties props = getPropFileGeneral();
      
      // Lecture dans le fichier Properties de la clé contenant
      // le numéro de port JMX
      String port = props.getProperty("sae.archivagemasse.jmx.port");
      int portJmx = Integer.parseInt(port); 
      
      // Renvoie le num port
      return portJmx;
      
   }
   
   
   /**
    * Récupération de l'objet properties representant le fichier de conf générale.
    * @throws IOException 
    */
   public static Properties getPropFileGeneral() throws IOException {
      // Récupération du File pointant sur le fichier de configuration
      // générale
      File fileConfig = getFileConfig();
      
      // Chargement du fichier de configuration générale
      // dans un objet Properties
      FileInputStream fileInput = new FileInputStream(fileConfig);
      Properties props = new Properties();
      try {
         props.load(fileInput);
      } finally {
         if (fileInput!=null) {
            fileInput.close();
         }
      }
      return props;
   }
   
}
